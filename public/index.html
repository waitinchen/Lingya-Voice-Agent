<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±å°è»Ÿ - èªéŸ³åŠ©æ‰‹ ğŸŒ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 700px;
        }

        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                align-items: flex-start;
            }

            .chat-container {
                height: calc(100vh - 10px); /* 100vh - ä¸Šä¸‹å„5px */
                max-height: none;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            .chat-header {
                padding: 15px;
                border-radius: 15px 15px 0 0;
            }

            .chat-header h1 {
                font-size: 20px;
            }

            .chat-messages {
                padding: 15px;
            }

            .chat-input {
                padding: 15px;
            }
        }

        /* è¶…å°å±å¹•ï¼ˆå°æ–¼ 480pxï¼‰*/
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .chat-container {
                height: calc(100vh - 10px);
                border-radius: 10px;
            }

            .chat-header {
                padding: 12px;
                border-radius: 10px 10px 0 0;
            }

            .chat-header h1 {
                font-size: 18px;
            }

            .chat-messages {
                padding: 12px;
                gap: 12px;
            }

            .message-content {
                max-width: 75%;
                padding: 10px 14px;
                font-size: 14px;
            }

            .chat-input {
                padding: 12px;
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message-audio {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audio-player {
            flex: 1;
            height: 30px;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group {
            flex: 1;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #eee;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-voice {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            position: relative;
        }

        .btn-voice:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-voice.recording {
            background: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 12px;
        }

        /* å£°éŸ³æ³¢æµªå¯è§†åŒ– */
        .voice-visualizer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .voice-visualizer.active {
            display: block;
        }

        .voice-visualizer canvas {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        .voice-visualizer-text {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 12px;
            text-align: center;
            width: 90%;
        }

        /* å®æ—¶è½¬å½•æ–‡å­—æ˜¾ç¤º */
        .realtime-transcript {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            display: none;
            z-index: 999;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            font-size: 16px;
            text-align: center;
        }

        .realtime-transcript.active {
            display: block;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .realtime-transcript .transcript-text {
            margin-bottom: 5px;
        }

        .realtime-transcript .transcript-hint {
            font-size: 12px;
            opacity: 0.8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ğŸŒ¸ èŠ±å°è»Ÿ- èªæ°£ä¹‹éˆ</h1>
        </div>
        
        <div class="chat-messages" id="messages">
            <div class="message assistant">
                <div class="message-avatar">ğŸŒ¸</div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯èŠ±å°è»Ÿï¼Œå¾ˆé«˜èˆˆèªè­˜ä½ ï¼ä½ å¯ä»¥æ‰“å­—æˆ–æŒ‰ä½èªéŸ³æŒ‰éˆ•èªªè©± ğŸ’«
                </div>
            </div>
        </div>
        
        <div class="chat-input">
            <div class="input-group">
                <input type="text" id="textInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
                <button class="btn-send" id="sendBtn">ç™¼é€</button>
            </div>
            <button class="btn-voice" id="voiceBtn" title="æŒ‰ä½èªªè©±">ğŸ¤</button>
        </div>
        
        <div class="status" id="status"></div>
    </div>

    <!-- å£°éŸ³æ³¢æµªå¯è§†åŒ– -->
    <div class="voice-visualizer" id="voiceVisualizer">
        <canvas id="audioCanvas"></canvas>
        <div class="voice-visualizer-text">æ­£åœ¨éŒ„éŸ³... ğŸ¤</div>
    </div>

    <!-- å®æ—¶è½¬å½•æ˜¾ç¤º -->
    <div class="realtime-transcript" id="realtimeTranscript">
        <div class="transcript-text" id="transcriptText"></div>
        <div class="transcript-hint">å®æ—¶è½¬å½•ä¸­...</div>
    </div>

    <script>
        const messagesEl = document.getElementById('messages');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const statusEl = document.getElementById('status');
        
        let conversationHistory = []; // Step â‘¢-B: å°è©±æ­·å²è¨˜æ†¶
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null; // éŒ„éŸ³é–‹å§‹æ™‚é–“
        const MIN_RECORDING_DURATION = 500; // æœ€å°éŒ„éŸ³æ™‚é•·ï¼ˆæ¯«ç§’ï¼‰ï¼š0.5ç§’
        let currentUserIdentity = null; // æ­¸å±¬è¨˜æ†¶ï¼šç”¨æˆ¶èº«ä»½ï¼ˆ'dad' è¡¨ç¤ºè€çˆ¸ï¼Œnull è¡¨ç¤ºæœªçŸ¥ï¼‰
        let currentUserName = null; // ç•¶å‰ç”¨æˆ¶åç¨±
        
        // å®æ—¶éŸ³é¢‘åˆ†æ
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let animationFrameId = null;
        
        // å®æ—¶è¯­éŸ³è¯†åˆ«
        let recognition = null;
        let realtimeTranscript = '';
        
        // Canvas å¯è§†åŒ–
        const visualizerEl = document.getElementById('voiceVisualizer');
        const canvas = document.getElementById('audioCanvas');
        const ctx = canvas.getContext('2d');
        const transcriptEl = document.getElementById('realtimeTranscript');
        const transcriptTextEl = document.getElementById('transcriptText');
        
        // è®¾ç½® Canvas å°ºå¯¸
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ç»˜åˆ¶éŸ³é¢‘æ³¢å½¢
        function drawWaveform() {
            if (!analyser || !isRecording) {
                animationFrameId = null;
                return;
            }
            
            analyser.getByteFrequencyData(dataArray);
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                barHeight = (dataArray[i] / 255) * canvas.height;
                
                // ä½¿ç”¨ç»¿è‰²æ¸å˜
                const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                gradient.addColorStop(0, '#4ade80'); // ç»¿è‰²
                gradient.addColorStop(0.5, '#22c55e'); // äº®ç»¿è‰²
                gradient.addColorStop(1, '#16a34a'); // æ·±ç»¿è‰²
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
            
            animationFrameId = requestAnimationFrame(drawWaveform);
        }
        
        // åˆå§‹åŒ–å®æ—¶è¯­éŸ³è¯†åˆ«ï¼ˆWeb Speech APIï¼‰
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = true;
                recognition.interimResults = true;
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // æ›´æ–°å®æ—¶è½¬å½•æ˜¾ç¤º
                    realtimeTranscript = finalTranscript || interimTranscript;
                    if (realtimeTranscript) {
                        transcriptTextEl.textContent = realtimeTranscript;
                        transcriptEl.classList.add('active');
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                };
                
                recognition.onend = () => {
                    if (isRecording) {
                        // å¦‚æœè¿˜åœ¨å½•éŸ³ï¼Œé‡æ–°å¯åŠ¨
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('è¯­éŸ³è¯†åˆ«å·²åœæ­¢');
                        }
                    }
                };
            } else {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API');
            }
        }

        // ç™¼é€æ–‡å­—è¨Šæ¯
        async function sendTextMessage() {
            const text = textInput.value.trim();
            if (!text) return;

            addMessage('user', text);
            textInput.value = '';
            setStatus('æ­£åœ¨æ€è€ƒ...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text,
                        history: conversationHistory, // Step â‘¢-B: å‚³éå°è©±æ­·å²
                        userIdentity: currentUserIdentity, // æ­¸å±¬è¨˜æ†¶ï¼šå‚³éèº«ä»½
                        userName: currentUserName, // å‚³éç”¨æˆ¶åç¨±
                    }),
                });
                
                // æª¢æ¸¬æ˜¯å¦æåˆ°ã€Œè€çˆ¸ã€é—œéµè©ï¼Œæ›´æ–°èƒŒæ™¯
                if (text.includes('è€çˆ¸') || text.includes('é™ˆå¨å»·') || text.includes('é™³å¨å»·')) {
                    document.body.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%)';
                    currentUserIdentity = 'dad';
                    console.log('ğŸ’– æª¢æ¸¬åˆ°è€çˆ¸ï¼Œåˆ‡æ›ç‚ºè¦ªæš±æ¨¡å¼');
                }

                const data = await response.json();
                const messageElement = addMessage('assistant', data.reply);
                
                // æ›´æ–°å°è©±æ­·å²
                if (data.history) {
                    conversationHistory = data.history;
                }
                
                // ç”Ÿæˆä¸¦æ’­æ”¾èªéŸ³ï¼ˆå¸¶æƒ…ç·’æ§åˆ¶ï¼‰ï¼Œä¸¦æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
                if (data.reply) {
                    playTextAsSpeech(data.reply, data.emotion, messageElement);
                }
            } catch (error) {
                addMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›å•é¡Œ ğŸ˜…');
                console.error('Error:', error);
            } finally {
                setStatus('');
            }
        }

        // ç™¼é€èªéŸ³è¨Šæ¯
        async function sendVoiceMessage(audioBlob, fileExtension = 'webm') {
            setStatus('æ­£åœ¨è™•ç†èªéŸ³...');
            console.log(`ğŸ“¤ ç™¼é€èªéŸ³è¨Šæ¯ï¼Œå¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);

            try {
                const formData = new FormData();
                // ä½¿ç”¨æ­£ç¢ºçš„æ–‡ä»¶æ“´å±•å
                formData.append('audio', audioBlob, `recording.${fileExtension}`);
                formData.append('language', 'zh');
                formData.append('history', JSON.stringify(conversationHistory));
                if (currentUserIdentity) {
                    formData.append('userIdentity', currentUserIdentity);
                }
                if (currentUserName) {
                    formData.append('userName', currentUserName);
                }

                console.log('ğŸ“¡ ç™¼é€è«‹æ±‚åˆ° /api/voice-chat...');
                const response = await fetch('/api/voice-chat', {
                    method: 'POST',
                    body: formData,
                });

                console.log(`ğŸ“¥ æ”¶åˆ°å›æ‡‰ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ æœå‹™å™¨éŒ¯èª¤:', errorText);
                    throw new Error(`æœå‹™å™¨éŒ¯èª¤: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('ğŸ“¦ å›æ‡‰æ•¸æ“š:', data);
                
                if (data.success) {
                    // é¡¯ç¤ºç”¨æˆ¶èªªçš„è©±
                    addMessage('user', data.transcribedText, true);
                    
                    // é¡¯ç¤ºèŠ±å°è»Ÿå›æ‡‰
                    addMessage('assistant', data.text, true, data.audio);
                    
                    // æ›´æ–°å°è©±æ­·å²ï¼ˆStep â‘¢-B: ä¿æŒè¨˜æ†¶ï¼‰
                    conversationHistory = data.history || [];
                    
                    // å¯é¸ï¼šé¡¯ç¤ºæª¢æ¸¬åˆ°çš„æƒ…ç·’
                    if (data.emotion && data.emotion !== 'å¹³éœ') {
                        console.log(`æª¢æ¸¬åˆ°æƒ…ç·’: ${data.emotion}`);
                    }
                    
                    // æª¢æ¸¬å›æ‡‰ä¸­æ˜¯å¦æåˆ°ã€Œæƒ³å›å®¶æ‰¾è€çˆ¸ã€ï¼Œè¡¨ç¤ºæ˜¯é™Œç”Ÿäººæ¨¡å¼
                    if (data.text && (data.text.includes('æƒ³å›å®¶') || data.text.includes('è€çˆ¸ä¸åœ¨') || data.text.includes('å›å®¶æ‰¾è€çˆ¸'))) {
                        document.body.style.background = 'linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%)';
                        if (!currentUserIdentity || currentUserIdentity !== 'dad') {
                            currentUserIdentity = 'other';
                            console.log('ğŸŒ æª¢æ¸¬åˆ°é™Œç”Ÿäººæ¨¡å¼ï¼ŒèŠ±å°è»Ÿæƒ³å›å®¶æ‰¾è€çˆ¸');
                        }
                    }
                } else {
                    console.error('âŒ èªéŸ³è™•ç†å¤±æ•—:', data.error || 'æœªçŸ¥éŒ¯èª¤');
                    addMessage('assistant', `æŠ±æ­‰ï¼Œæˆ‘æ²’è½æ¸…æ¥šï¼Œå¯ä»¥å†èªªä¸€æ¬¡å—ï¼ŸğŸ˜… (éŒ¯èª¤: ${data.error || 'æœªçŸ¥'})`);
                }
            } catch (error) {
                console.error('âŒ èªéŸ³è™•ç†éŒ¯èª¤:', error);
                addMessage('assistant', `èªéŸ³è™•ç†é‡åˆ°å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ ğŸ˜… (${error.message})`);
            } finally {
                setStatus('');
            }
        }

        // æ·»åŠ è¨Šæ¯åˆ°èŠå¤©
        function addMessage(role, text, isVoice = false, audioBase64 = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            
            const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸŒ¸';
            
            let audioHtml = '';
            if (isVoice && audioBase64) {
                audioHtml = `
                    <div class="message-audio">
                        <audio class="audio-player" controls>
                            <source src="data:audio/wav;base64,${audioBase64}" type="audio/wav">
                        </audio>
                    </div>
                `;
            }
            
            messageEl.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${text}
                    ${audioHtml}
                </div>
            `;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // è¿”å›æ¶ˆæ¯å…ƒç´ ï¼Œæ–¹ä¾¿å¾ŒçºŒæ·»åŠ éŸ³é »æ’­æ”¾å™¨
            return messageEl;
        }

        // æ’­æ”¾æ–‡å­—ç‚ºèªéŸ³ï¼ˆæ”¯æŒæƒ…ç·’æ§åˆ¶ï¼‰ï¼Œä¸¦æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
        async function playTextAsSpeech(text, emotion = null, messageElement = null) {
            try {
                const response = await fetch('/api/speak-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text,
                        emotion, // Step â‘¢-B: å‚³éæƒ…ç·’è®“èªéŸ³è¡¨é”ç›¸æ‡‰èªæ°£
                    }),
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // å¦‚æœæä¾›äº†æ¶ˆæ¯å…ƒç´ ï¼Œæ·»åŠ éŸ³é »æ’­æ”¾å™¨
                    if (messageElement) {
                        addAudioPlayerToMessage(messageElement, audioUrl);
                    }
                    
                    // è‡ªå‹•æ’­æ”¾
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            } catch (error) {
                console.error('TTS Error:', error);
            }
        }
        
        // æ·»åŠ éŸ³é »æ’­æ”¾å™¨åˆ°æ¶ˆæ¯ä¸­
        function addAudioPlayerToMessage(messageElement, audioUrl) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰éŸ³é »æ’­æ”¾å™¨
            const existingAudio = messageElement.querySelector('.message-audio');
            if (existingAudio) {
                // æ›´æ–°ç¾æœ‰æ’­æ”¾å™¨çš„æº
                const audio = existingAudio.querySelector('audio');
                if (audio) {
                    audio.src = audioUrl;
                }
                return;
            }
            
            // å‰µå»ºæ–°çš„éŸ³é »æ’­æ”¾å™¨
            const messageContent = messageElement.querySelector('.message-content');
            if (messageContent) {
                const audioHtml = `
                    <div class="message-audio">
                        <audio class="audio-player" controls>
                            <source src="${audioUrl}" type="audio/wav">
                        </audio>
                    </div>
                `;
                messageContent.insertAdjacentHTML('beforeend', audioHtml);
            }
        }

        // é–‹å§‹éŒ„éŸ³ï¼ˆå¸¶å¯¦æ™‚å¯è¦–åŒ–å’ŒèªéŸ³è­˜åˆ¥ï¼‰
        async function startRecording() {
            try {
                console.log('ğŸ¤ é–‹å§‹éŒ„éŸ³...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // åˆå§‹åŒ– Web Audio APIï¼ˆç”¨æ–¼å¯è¦–åŒ–ï¼‰
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // é¡¯ç¤ºå¯è¦–åŒ–
                visualizerEl.classList.add('active');
                drawWaveform();
                
                // å•Ÿå‹•å¯¦æ™‚èªéŸ³è­˜åˆ¥
                if (recognition) {
                    try {
                        recognition.start();
                        console.log('ğŸ™ï¸ å¯¦æ™‚èªéŸ³è­˜åˆ¥å·²å•Ÿå‹•');
                    } catch (e) {
                        console.log('èªéŸ³è­˜åˆ¥å¯èƒ½å·²ç¶“å•Ÿå‹•');
                    }
                }
                
                // æª¢æ¸¬æ”¯æŒçš„ MIME é¡å‹
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                    mimeType = 'audio/webm';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                }
                
                console.log(`ğŸ“ ä½¿ç”¨éŸ³é »æ ¼å¼: ${mimeType}`);
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });
                
                audioChunks = [];
                realtimeTranscript = ''; // é‡ç½®è½‰éŒ„æ–‡å­—
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        console.log(`ğŸ“¦ éŒ„éŸ³æ•¸æ“šå¡Š: ${event.data.size} bytes`);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const recordingDuration = recordingStartTime ? Date.now() - recordingStartTime : 0;
                    console.log(`âœ… éŒ„éŸ³å®Œæˆï¼Œå…± ${audioChunks.length} å€‹æ•¸æ“šå¡Šï¼Œæ™‚é•·: ${(recordingDuration / 1000).toFixed(2)} ç§’`);
                    
                    // åœæ­¢å¯è¦–åŒ–
                    visualizerEl.classList.remove('active');
                    transcriptEl.classList.remove('active');
                    
                    // åœæ­¢èªéŸ³è­˜åˆ¥
                    if (recognition) {
                        recognition.stop();
                    }
                    
                    // åœæ­¢éŸ³é »åˆ†æ
                    if (microphone) {
                        microphone.disconnect();
                    }
                    if (audioContext && audioContext.state !== 'closed') {
                        audioContext.close();
                    }
                    
                    // æª¢æŸ¥éŒ„éŸ³æ™‚é•·
                    if (recordingDuration < MIN_RECORDING_DURATION) {
                        console.warn(`âš ï¸ éŒ„éŸ³æ™‚é•·å¤ªçŸ­: ${(recordingDuration / 1000).toFixed(2)} ç§’ï¼Œæœ€å°è¦æ±‚: ${(MIN_RECORDING_DURATION / 1000).toFixed(1)} ç§’`);
                        setStatus(`éŒ„éŸ³å¤ªçŸ­ï¼Œè«‹è‡³å°‘éŒ„è£½ ${(MIN_RECORDING_DURATION / 1000).toFixed(1)} ç§’ï¼ˆç›®å‰ ${(recordingDuration / 1000).toFixed(1)} ç§’ï¼‰`);
                        stream.getTracks().forEach(track => track.stop());
                        isRecording = false;
                        voiceBtn.classList.remove('recording');
                        recordingStartTime = null;
                        
                        // æ¸…ç†å¯è¦–åŒ–å’Œè½‰éŒ„
                        if (visualizerEl) visualizerEl.classList.remove('active');
                        if (transcriptEl) transcriptEl.classList.remove('active');
                        return;
                    }
                    
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    console.log(`ğŸ“Š éŸ³é » Blob å¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
                    
                    // æª¢æŸ¥éŸ³é »æ–‡ä»¶å¤§å°ï¼ˆè‡³å°‘ 2KBï¼Œç¢ºä¿æœ‰å¯¦éš›å…§å®¹ï¼‰
                    if (audioBlob.size < 2048) {
                        console.warn(`âš ï¸ éŸ³é »æ–‡ä»¶å¤ªå°: ${audioBlob.size} bytesï¼Œå¯èƒ½æ˜¯ç©ºéŒ„éŸ³æˆ–æ ¼å¼å•é¡Œ`);
                        setStatus(`éŒ„éŸ³å…§å®¹å¤ªçŸ­æˆ–ç„¡æ•ˆï¼ˆ${(audioBlob.size / 1024).toFixed(2)} KBï¼‰ï¼Œè«‹é‡æ–°éŒ„è£½è‡³å°‘ 0.5 ç§’`);
                        stream.getTracks().forEach(track => track.stop());
                        isRecording = false;
                        voiceBtn.classList.remove('recording');
                        recordingStartTime = null;
                        
                        // æ¸…ç†å¯è¦–åŒ–å’Œè½‰éŒ„
                        if (visualizerEl) visualizerEl.classList.remove('active');
                        if (transcriptEl) transcriptEl.classList.remove('active');
                        return;
                    }
                    
                    // é©—è­‰éŸ³é »æ ¼å¼æ˜¯å¦æœ‰æ•ˆ
                    if (!audioBlob.type || audioBlob.type === 'application/octet-stream') {
                        console.warn(`âš ï¸ éŸ³é »æ ¼å¼æœªè­˜åˆ¥: ${audioBlob.type}`);
                        // æ ¹æ“š mimeType è¨­ç½®æ­£ç¢ºçš„ type
                        audioBlob.type = mimeType;
                    }
                    
                    // ç¢ºå®šæ–‡ä»¶æ“´å±•åï¼ˆå„ªå…ˆä½¿ç”¨ Whisper æ”¯æŒçš„æ ¼å¼ï¼‰
                    // Whisper API æ”¯æŒï¼šflac, m4a, mp3, mp4, mpeg, mpga, oga, ogg, wav, webm
                    let fileExtension = 'webm';
                    if (mimeType.includes('mp4')) {
                        fileExtension = 'mp4';
                    } else if (mimeType.includes('webm')) {
                        fileExtension = 'webm';
                    } else if (mimeType.includes('ogg')) {
                        fileExtension = 'ogg';
                    }
                    // æ³¨æ„ï¼šå¦‚æœç€è¦½å™¨ä¸æ”¯æŒ webmï¼Œå¯èƒ½éœ€è¦è½‰æ›ç‚º wav
                    // ä½†ç›®å‰å…ˆä½¿ç”¨ç€è¦½å™¨åŸç”Ÿæ ¼å¼
                    
                    console.log(`ğŸ“¦ éŸ³é »æ ¼å¼: ${mimeType}, æ“´å±•å: ${fileExtension}`);
                    
                    // å¦‚æœæœ‰å¯¦æ™‚è½‰éŒ„çš„æ–‡å­—ï¼Œä½¿ç”¨å®ƒï¼›å¦å‰‡ç™¼é€éŸ³é »
                    if (realtimeTranscript.trim()) {
                        console.log(`ğŸ“ ä½¿ç”¨å¯¦æ™‚è½‰éŒ„: "${realtimeTranscript}"`);
                        // ç›´æ¥ä½¿ç”¨è½‰éŒ„çš„æ–‡å­—ç™¼é€
                        await sendTextAsVoice(realtimeTranscript);
                    } else {
                        await sendVoiceMessage(audioBlob, fileExtension);
                    }
                    
                    stream.getTracks().forEach(track => track.stop());
                    recordingStartTime = null;
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('âŒ MediaRecorder éŒ¯èª¤:', event.error);
                    setStatus('éŒ„éŸ³ç™¼ç”ŸéŒ¯èª¤');
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now(); // è¨˜éŒ„é–‹å§‹æ™‚é–“
                voiceBtn.classList.add('recording');
                setStatus('æ­£åœ¨éŒ„éŸ³...');
                console.log('ğŸ™ï¸ éŒ„éŸ³ä¸­...');
            } catch (error) {
                console.error('âŒ éŒ„éŸ³éŒ¯èª¤:', error);
                if (error.name === 'NotAllowedError') {
                    setStatus('ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼šè«‹å…è¨±ç€è¦½å™¨è¨ªå•éº¥å…‹é¢¨æ¬Šé™');
                } else if (error.name === 'NotFoundError') {
                    setStatus('æ‰¾ä¸åˆ°éº¥å…‹é¢¨è¨­å‚™');
                } else {
                    setStatus('ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼š' + error.message);
                }
                
                // æ¸…ç†è³‡æº
                if (visualizerEl) visualizerEl.classList.remove('active');
                if (transcriptEl) transcriptEl.classList.remove('active');
                if (recognition) recognition.stop();
                recordingStartTime = null;
            }
        }
        
        // ä½¿ç”¨å¯¦æ™‚è½‰éŒ„çš„æ–‡å­—ç™¼é€ï¼ˆä½œç‚ºèªéŸ³è¼¸å…¥ï¼‰
        async function sendTextAsVoice(text) {
            setStatus('æ­£åœ¨è™•ç†...');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        history: conversationHistory,
                        userIdentity: currentUserIdentity,
                        userName: currentUserName,
                    }),
                });
                
                    const data = await response.json();
                    const messageElement = addMessage('assistant', data.reply);
                    
                    if (data.history) {
                        conversationHistory = data.history;
                    }
                    
                    if (data.reply) {
                        playTextAsSpeech(data.reply, data.emotion, messageElement);
                    }
            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›å•é¡Œ ğŸ˜…');
            } finally {
                setStatus('');
            }
        }

        // åœæ­¢éŒ„éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                // æª¢æŸ¥éŒ„éŸ³æ™‚é•·ï¼ˆåœ¨åœæ­¢å‰æª¢æŸ¥ï¼‰
                const recordingDuration = recordingStartTime ? Date.now() - recordingStartTime : 0;
                
                if (recordingDuration < MIN_RECORDING_DURATION) {
                    console.warn(`âš ï¸ éŒ„éŸ³æ™‚é•·å¤ªçŸ­: ${(recordingDuration / 1000).toFixed(2)} ç§’ï¼Œå»ºè­°ç¹¼çºŒéŒ„éŸ³...`);
                    setStatus(`ğŸ’¡ å»ºè­°è‡³å°‘éŒ„è£½ ${(MIN_RECORDING_DURATION / 1000).toFixed(1)} ç§’ï¼ˆç›®å‰ ${(recordingDuration / 1000).toFixed(1)} ç§’ï¼‰`);
                    
                    // å¦‚æœçœŸçš„å¾ˆçŸ­ï¼ˆ< 0.3ç§’ï¼‰ï¼Œå¼·åˆ¶ç¹¼çºŒéŒ„éŸ³
                    if (recordingDuration < 300) {
                        console.log('â¸ï¸ éŒ„éŸ³å¤ªçŸ­ï¼Œç¹¼çºŒéŒ„éŸ³...');
                        return;
                    }
                    // å¦‚æœæ¥è¿‘æœ€å°å€¼ï¼Œå…è¨±åœæ­¢ä½†æœƒé¡¯ç¤ºè­¦å‘Š
                }
                
                console.log('â¹ï¸  åœæ­¢éŒ„éŸ³...');
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                setStatus('æ­£åœ¨è™•ç†èªéŸ³...');
                
                // åœæ­¢å¯è¦–åŒ–å‹•ç•«
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                
                // åœæ­¢èªéŸ³è­˜åˆ¥
                if (recognition) {
                    recognition.stop();
                }
            }
        }

        // å·¥å…·å‡½æ•¸
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function setStatus(text) {
            statusEl.textContent = text;
        }

        // äº‹ä»¶ç›£è½
        sendBtn.addEventListener('click', sendTextMessage);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendTextMessage();
        });

        // èªéŸ³æŒ‰éˆ•äº‹ä»¶ï¼ˆæŒ‰ä½èªªè©±ï¼‰
        voiceBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startRecording();
        });
        voiceBtn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            stopRecording();
        });
        voiceBtn.addEventListener('mouseleave', (e) => {
            if (isRecording) {
                stopRecording();
            }
        });
        
        // è§¸æ‘¸äº‹ä»¶ï¼ˆç§»å‹•è¨­å‚™ï¼‰
        voiceBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startRecording();
        });
        voiceBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRecording();
        });
        voiceBtn.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            if (isRecording) {
                stopRecording();
            }
        });
        
        // é»æ“Šäº‹ä»¶ï¼ˆå‚™ç”¨ï¼šé»æ“Šé–‹å§‹ï¼Œå†æ¬¡é»æ“Šåœæ­¢ï¼‰
        let clickTimer = null;
        voiceBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!isRecording) {
                startRecording();
                // è‡ªå‹•åœ¨ 30 ç§’å¾Œåœæ­¢ï¼ˆé˜²æ­¢å¿˜è¨˜ï¼‰
                clickTimer = setTimeout(() => {
                    if (isRecording) {
                        console.log('â° è‡ªå‹•åœæ­¢éŒ„éŸ³ï¼ˆ30ç§’è¶…æ™‚ï¼‰');
                        stopRecording();
                    }
                }, 30000);
            } else {
                if (clickTimer) clearTimeout(clickTimer);
                stopRecording();
            }
        });
        
        // åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
        initSpeechRecognition();
    </script>
</body>
</html>

