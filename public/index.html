<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é»ƒè“‰ - èªéŸ³åŠ©æ‰‹ ğŸ¦Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 700px;
            position: relative;
            overflow: hidden;
        }

        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            body {
                padding: 0;
                align-items: flex-start;
                justify-content: flex-start;
                height: 100vh;
                height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ï¼Œæ”¯æŒç§»åŠ¨ç«¯ */
                overflow: hidden;
            }

            .chat-container {
                height: 100vh;
                height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
                max-height: none;
                border-radius: 0;
                box-shadow: none;
                width: 100%;
                max-width: 100%;
            }

            .chat-header {
                padding: 15px;
                padding-top: max(15px, env(safe-area-inset-top)); /* æ”¯æŒå®‰å…¨åŒºåŸŸï¼ˆé¡¶éƒ¨ï¼‰ */
                border-radius: 0;
                flex-shrink: 0;
            }

            .chat-header h1 {
                font-size: 20px;
            }

            .chat-messages {
                padding: 15px;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
            }

            .chat-input {
                padding: 12px 15px;
                padding-bottom: max(12px, env(safe-area-inset-bottom)); /* æ”¯æŒå®‰å…¨åŒºåŸŸï¼ˆåº•éƒ¨ï¼‰ */
                border-top: 1px solid #eee;
                flex-shrink: 0;
                background: white;
                position: relative;
                z-index: 10;
            }
            
            /* æ‰‹æ©Ÿç‰ˆè¼¸å…¥æ¡†æ”¹å–„ï¼šé¿å…è¢«éµç›¤æ“‹ä½ */
            .input-group {
                position: relative;
                z-index: 10;
            }
        }

        /* è¶…å°å±å¹•ï¼ˆå°æ–¼ 480pxï¼‰*/
        @media (max-width: 480px) {
            body {
                padding: 0;
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
            }

            .chat-container {
                height: 100vh;
                height: 100dvh;
                border-radius: 0;
                max-height: 100vh;
                width: 100%;
                max-width: 100%;
            }

            .chat-header {
                padding: 12px 15px;
                padding-top: max(12px, env(safe-area-inset-top));
                border-radius: 0;
                flex-shrink: 0;
            }

            .chat-header h1 {
                font-size: 18px;
            }

            .chat-messages {
                padding: 12px 15px;
                padding-bottom: 10px;
                gap: 12px;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .message-content {
                max-width: 75%;
                padding: 10px 14px;
                font-size: 14px;
            }

            .chat-input {
                padding: 10px 15px;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
                position: relative;
                bottom: auto;
                background: white;
                border-top: 1px solid #eee;
                z-index: 100;
                flex-shrink: 0;
            }
            
            /* è¼¸å…¥æ¡†çµ„æ”¹å–„ */
            .input-group {
                position: relative;
                z-index: 10;
            }
            
            input[type="text"] {
                padding: 12px 16px;
                font-size: 16px; /* é˜²æ­¢ iOS Safari è‡ªå‹•ç¸®æ”¾ */
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch; /* iOS å¹³æ»‘æ»šåŠ¨ */
        }

        .message {
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.assistant .message-avatar {
            background-image: url('/images/huangrong-avatar.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: transparent; /* éš±è— emoji æ–‡å­— */
            overflow: hidden;
            /* å¦‚æœåœ–ç‰‡ä¸å­˜åœ¨ï¼Œé¡¯ç¤ºé»˜èªèƒŒæ™¯ */
            background-color: #f093fb;
            background-blend-mode: overlay;
        }
        
        /* åœ–ç‰‡åŠ è¼‰å¤±æ•—æ™‚çš„å‚™ç”¨æ¨£å¼ */
        .message.assistant .message-avatar::before {
            content: 'ğŸŒ¸';
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .message.assistant .message-avatar:not([style*="background-image"])::before,
        .message.assistant .message-avatar[data-image-error="true"]::before {
            opacity: 1;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        
        /* æ€è€ƒæ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
        .message.thinking-message .message-content {
            background: #f0f0f0;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .message-audio {
            display: block !important; /* ç¢ºä¿éŸ³é »å®¹å™¨å§‹çµ‚é¡¯ç¤º */
            margin-top: 8px;
            width: 100%;
        }

        .audio-player {
            flex: 1;
            height: 30px;
            display: block !important; /* ç¢ºä¿æ’­æ”¾å™¨å§‹çµ‚é¡¯ç¤º */
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group {
            flex: 1;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #eee;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-voice {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            position: relative;
            display: none; /* éš±è—éŒ„éŸ³æŒ‰éˆ•ï¼ˆåŠŸèƒ½ä¸å®Œå–„ï¼‰ */
        }

        .btn-voice:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-voice.recording {
            background: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 12px;
        }

        /* å£°éŸ³æ³¢æµªå¯è§†åŒ– */
        .voice-visualizer {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 140px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 18px;
            padding: 18px;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .voice-visualizer.active {
            display: block;
        }

        .voice-visualizer canvas {
            width: 100%;
            height: calc(100% - 25px);
            border-radius: 8px;
        }

        .voice-visualizer-text {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            color: #4ade80;
            font-size: 11px;
            text-align: center;
            width: 90%;
            font-weight: 500;
        }

        /* å®æ—¶è½¬å½•æ–‡å­—æ˜¾ç¤º */
        .realtime-transcript {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            max-width: 500px;
            width: 80%;
            display: none;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            font-size: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .realtime-transcript.active {
            display: block;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .realtime-transcript .transcript-text {
            margin-bottom: 3px;
            font-weight: 500;
            min-height: 20px;
        }

        .realtime-transcript .transcript-hint {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 3px;
        }
        
        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .realtime-transcript {
                top: 45%;
                max-width: 85%;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .voice-visualizer {
                width: 250px;
                height: 120px;
                padding: 15px;
            }
            
            .voice-visualizer-text {
                font-size: 11px;
                bottom: 8px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ä¸‰é¢—çƒè·³è·ƒåŠ¨ç”» */
        .thinking-animation {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }
        
        .thinking-ball {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            animation: bounce 1.4s ease-in-out infinite;
        }
        
        .thinking-ball:nth-child(1) {
            animation-delay: 0s;
        }
        
        .thinking-ball:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .thinking-ball:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }
            40% {
                transform: translateY(-20px) scale(1.1);
                opacity: 1;
            }
        }
        
        /* èªæ°£æ¨™ç±¤æ¨£å¼ */
        .tone-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
            font-size: 0.75rem;
            opacity: 0.75;
            border-radius: 12px;
            background: rgba(255, 182, 193, 0.2);
            padding: 3px 8px;
            color: #ff5fa2;
            transition: opacity 0.2s ease;
        }
        
        .tone-tag:hover {
            opacity: 1;
            background: rgba(255, 182, 193, 0.3);
        }
        
        .tone-emoji {
            font-size: 1rem;
            line-height: 1;
        }
        
        .tone-label {
            font-weight: 500;
            letter-spacing: 0.05em;
            font-size: 0.7rem;
        }
        
        /* èˆˆå¥®èªæ°£å‹•ç•«ï¼ˆå¯é¸ï¼‰ */
        .tone-tag[data-tag="excited"] {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 0.75;
            }
            50% {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>é»ƒè“‰</h1>
        </div>
        
        <div class="chat-messages" id="messages">
            <div class="message assistant">
                <div class="message-avatar"></div>
                <div class="message-content">
                    å–²ï½ä½ åœ¨è·Ÿæˆ‘èªªè©±å—ï¼Ÿæˆ‘æ˜¯é»ƒè“‰å•Šï½å‰›å¾æ¡ƒèŠ±å³¶ç©¿è¶Šéä¾†çš„ï¼
                </div>
            </div>
        </div>
        
        <div class="chat-input">
            <div class="input-group">
                <input type="text" id="textInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
                <button class="btn-send" id="sendBtn">ç™¼é€</button>
            </div>
            <button class="btn-voice" id="voiceBtn" title="æŒ‰ä½èªªè©±">ğŸ¤</button>
        </div>
        
        <div class="status" id="status"></div>
    </div>

    <!-- å£°éŸ³æ³¢æµªå¯è§†åŒ– -->
    <div class="voice-visualizer" id="voiceVisualizer">
        <canvas id="audioCanvas"></canvas>
        <div class="voice-visualizer-text">æ­£åœ¨éŒ„éŸ³... ğŸ¤</div>
    </div>

    <!-- å®æ—¶è½¬å½•æ˜¾ç¤º -->
    <div class="realtime-transcript" id="realtimeTranscript">
        <div class="transcript-text" id="transcriptText"></div>
    </div>

    <script>
        const messagesEl = document.getElementById('messages');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        
        // çŠ¶æ€ç®¡ç†ï¼šé˜²æ­¢è¯­éŸ³é‡å 
        let isVoiceGenerating = false; // æ˜¯å¦æ­£åœ¨ç”Ÿæˆè¯­éŸ³
        let isVoicePlaying = false; // æ˜¯å¦æ­£åœ¨æ’­æ”¾è¯­éŸ³
        let currentAudio = null; // å½“å‰æ’­æ”¾çš„éŸ³é¢‘å¯¹è±¡
        const statusEl = document.getElementById('status');
        
        let conversationHistory = []; // Step â‘¢-B: å°è©±æ­·å²è¨˜æ†¶
        let messageHistory = []; // ä¿å­˜é¡¯ç¤ºçš„æ¶ˆæ¯ï¼ˆç”¨æ–¼æ¢å¾©å°è©±è¨˜éŒ„ï¼‰
        const STORAGE_KEY_HISTORY = 'lingya_conversation_history'; // localStorage key for conversation history
        const STORAGE_KEY_MESSAGES = 'lingya_message_history'; // localStorage key for message display
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null; // éŒ„éŸ³é–‹å§‹æ™‚é–“
        const MIN_RECORDING_DURATION = 500; // æœ€å°éŒ„éŸ³æ™‚é•·ï¼ˆæ¯«ç§’ï¼‰ï¼š0.5ç§’
        let currentUserIdentity = null; // æ­¸å±¬è¨˜æ†¶ï¼šç”¨æˆ¶èº«ä»½ï¼ˆ'dad' è¡¨ç¤ºè€çˆ¸ï¼Œnull è¡¨ç¤ºæœªçŸ¥ï¼‰
        let currentUserName = null; // ç•¶å‰ç”¨æˆ¶åç¨±
        
        // ========================================
        // localStorage å°è©±è¨˜éŒ„ç®¡ç†
        // ========================================
        
        // ä¿å­˜å°è©±æ­·å²åˆ° localStorage
        function saveConversationHistory() {
            try {
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(conversationHistory));
                localStorage.setItem(STORAGE_KEY_MESSAGES, JSON.stringify(messageHistory));
                console.log('ğŸ’¾ å°è©±è¨˜éŒ„å·²ä¿å­˜åˆ° localStorage');
            } catch (error) {
                console.error('âŒ ä¿å­˜å°è©±è¨˜éŒ„å¤±æ•—:', error);
            }
        }
        
        // å¾ localStorage æ¢å¾©å°è©±è¨˜éŒ„
        function restoreConversationHistory() {
            try {
                const savedHistory = localStorage.getItem(STORAGE_KEY_HISTORY);
                const savedMessages = localStorage.getItem(STORAGE_KEY_MESSAGES);
                
                if (savedHistory) {
                    conversationHistory = JSON.parse(savedHistory);
                    console.log(`ğŸ“– å·²æ¢å¾©å°è©±æ­·å²ï¼ˆ${conversationHistory.length} è¼ªå°è©±ï¼‰`);
                }
                
                if (savedMessages) {
                    messageHistory = JSON.parse(savedMessages);
                    console.log(`ğŸ“– å·²æ¢å¾©æ¶ˆæ¯è¨˜éŒ„ï¼ˆ${messageHistory.length} æ¢æ¶ˆæ¯ï¼‰`);
                    
                    // æ¢å¾©æ¶ˆæ¯é¡¯ç¤ºï¼ˆæ’é™¤æ­¡è¿æ¶ˆæ¯ï¼‰
                    const welcomeMessage = messagesEl.querySelector('.message.assistant');
                    messagesEl.innerHTML = '';
                    if (welcomeMessage) {
                        messagesEl.appendChild(welcomeMessage);
                    }
                    
                    // æ¢å¾©æ‰€æœ‰æ¶ˆæ¯
                    messageHistory.forEach(msg => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${msg.role}`;
                        
                        const avatar = msg.role === 'user' ? 'ğŸ‘¤' : ''; // åŠ©æ‰‹é ­åƒä½¿ç”¨åœ–ç‰‡
                        
                        let audioHtml = '';
                        if (msg.audioBase64) {
                            audioHtml = `
                                <div class="message-audio">
                                    <audio class="audio-player" controls>
                                        <source src="data:audio/wav;base64,${msg.audioBase64}" type="audio/wav">
                                    </audio>
                                </div>
                            `;
                        }
                        
                        // èªæ°£æ¨™ç±¤ï¼ˆåªåœ¨åŠ©æ‰‹æ¶ˆæ¯ä¸”å­˜åœ¨ toneTag æ™‚é¡¯ç¤ºï¼‰
                        let toneTagHtml = '';
                        if (msg.role === 'assistant' && msg.toneTag && msg.toneTag.emoji && msg.toneTag.label) {
                            toneTagHtml = `
                                <div class="tone-tag">
                                    <span class="tone-emoji">${msg.toneTag.emoji}</span>
                                    <span class="tone-label">${msg.toneTag.label}</span>
                                </div>
                            `;
                        }
                        
                        messageEl.innerHTML = `
                            <div class="message-avatar">${avatar}</div>
                            <div class="message-content">
                                ${msg.text}
                                ${audioHtml}
                                ${toneTagHtml}
                            </div>
                        `;
                        
                        messagesEl.appendChild(messageEl);
                    });
                    
                    // æ»¾å‹•åˆ°åº•éƒ¨
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
            } catch (error) {
                console.error('âŒ æ¢å¾©å°è©±è¨˜éŒ„å¤±æ•—:', error);
            }
        }
        
        // æ¸…é™¤å°è©±è¨˜éŒ„ï¼ˆå¯é¸åŠŸèƒ½ï¼‰
        function clearConversationHistory() {
            try {
                localStorage.removeItem(STORAGE_KEY_HISTORY);
                localStorage.removeItem(STORAGE_KEY_MESSAGES);
                conversationHistory = [];
                messageHistory = [];
                console.log('ğŸ—‘ï¸ å°è©±è¨˜éŒ„å·²æ¸…é™¤');
            } catch (error) {
                console.error('âŒ æ¸…é™¤å°è©±è¨˜éŒ„å¤±æ•—:', error);
            }
        }
        
        // å®æ—¶éŸ³é¢‘åˆ†æ
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let animationFrameId = null;
        
        // é™éŸ³æ£€æµ‹ï¼ˆè‡ªåŠ¨åœæ­¢å½•éŸ³ï¼‰
        let silenceStartTime = null; // é™éŸ³å¼€å§‹æ—¶é—´
        const SILENCE_THRESHOLD = 30; // éŸ³é‡é˜ˆå€¼ï¼ˆ0-255ï¼Œä½äºæ­¤å€¼è§†ä¸ºé™éŸ³ï¼‰
        const MAX_SILENCE_DURATION = 4000; // æœ€å¤§é™éŸ³æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ï¼š4ç§’
        
        // å®æ—¶è¯­éŸ³è¯†åˆ«
        let recognition = null;
        let realtimeTranscript = '';
        
        // Canvas å¯è§†åŒ–
        const visualizerEl = document.getElementById('voiceVisualizer');
        const canvas = document.getElementById('audioCanvas');
        const ctx = canvas.getContext('2d');
        const transcriptEl = document.getElementById('realtimeTranscript');
        const transcriptTextEl = document.getElementById('transcriptText');
        
        // è®¾ç½® Canvas å°ºå¯¸
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ç»˜åˆ¶éŸ³é¢‘æ³¢å½¢ï¼ˆå¸¦é™éŸ³æ£€æµ‹ï¼‰
        function drawWaveform() {
            if (!analyser || !isRecording) {
                animationFrameId = null;
                return;
            }
            
            analyser.getByteFrequencyData(dataArray);
            
            // è®¡ç®—å¹³å‡éŸ³é‡ï¼ˆç”¨äºé™éŸ³æ£€æµ‹ï¼‰
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const averageVolume = sum / dataArray.length;
            
            // é™éŸ³æ£€æµ‹é€»è¾‘
            if (averageVolume < SILENCE_THRESHOLD) {
                // æ£€æµ‹åˆ°é™éŸ³
                if (silenceStartTime === null) {
                    // è®°å½•é™éŸ³å¼€å§‹æ—¶é—´
                    silenceStartTime = Date.now();
                    console.log('ğŸ”‡ æ£€æµ‹åˆ°é™éŸ³ï¼Œå¼€å§‹è®¡æ—¶...');
                } else {
                    // æ£€æŸ¥é™éŸ³æŒç»­æ—¶é—´
                    const silenceDuration = Date.now() - silenceStartTime;
                    if (silenceDuration >= MAX_SILENCE_DURATION) {
                        // é™éŸ³è¶…è¿‡4ç§’ï¼Œè‡ªåŠ¨åœæ­¢å½•éŸ³
                        console.log(`â° é™éŸ³è¶…è¿‡ ${MAX_SILENCE_DURATION / 1000} ç§’ï¼Œè‡ªåŠ¨åœæ­¢å½•éŸ³å¹¶å‘é€`);
                        silenceStartTime = null;
                        if (mediaRecorder && isRecording) {
                            stopRecording();
                        }
                        return;
                    }
                }
            } else {
                // æœ‰å£°éŸ³ï¼Œé‡ç½®é™éŸ³è®¡æ—¶
                if (silenceStartTime !== null) {
                    silenceStartTime = null;
                    console.log('ğŸ”Š æ£€æµ‹åˆ°å£°éŸ³ï¼Œé‡ç½®é™éŸ³è®¡æ—¶');
                }
            }
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                barHeight = (dataArray[i] / 255) * canvas.height;
                
                // ä½¿ç”¨ç»¿è‰²æ¸å˜
                const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                gradient.addColorStop(0, '#4ade80'); // ç»¿è‰²
                gradient.addColorStop(0.5, '#22c55e'); // äº®ç»¿è‰²
                gradient.addColorStop(1, '#16a34a'); // æ·±ç»¿è‰²
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
            
            animationFrameId = requestAnimationFrame(drawWaveform);
        }
        
        // åˆå§‹åŒ–å®æ—¶è¯­éŸ³è¯†åˆ«ï¼ˆWeb Speech APIï¼‰
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = true;
                recognition.interimResults = true;
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // æ›´æ–°å®æ—¶è½¬å½•æ˜¾ç¤º
                    realtimeTranscript = finalTranscript || interimTranscript;
                    if (realtimeTranscript) {
                        transcriptTextEl.textContent = realtimeTranscript;
                        transcriptEl.classList.add('active');
                    } else {
                        // å¦‚æœæ²¡æœ‰è½¬å½•å†…å®¹ï¼Œæ˜¾ç¤ºæç¤º
                        transcriptTextEl.textContent = 'æ­£åœ¨è¯†åˆ«è¯­éŸ³...';
                        transcriptEl.classList.add('active');
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                };
                
                recognition.onend = () => {
                    if (isRecording) {
                        // å¦‚æœè¿˜åœ¨å½•éŸ³ï¼Œé‡æ–°å¯åŠ¨
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('è¯­éŸ³è¯†åˆ«å·²åœæ­¢');
                        }
                    }
                };
            } else {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API');
            }
        }

        // å•Ÿç”¨/ç¦ç”¨è¼¸å…¥
        function setInputEnabled(enabled) {
            textInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            voiceBtn.disabled = !enabled;
            
            if (enabled) {
                textInput.style.opacity = '1';
                sendBtn.style.opacity = '1';
                voiceBtn.style.opacity = '1';
                sendBtn.style.cursor = 'pointer';
                voiceBtn.style.cursor = 'pointer';
            } else {
                textInput.style.opacity = '0.5';
                sendBtn.style.opacity = '0.5';
                voiceBtn.style.opacity = '0.5';
                sendBtn.style.cursor = 'not-allowed';
                voiceBtn.style.cursor = 'not-allowed';
            }
        }

        // ç™¼é€æ–‡å­—è¨Šæ¯
        async function sendTextMessage() {
            const text = textInput.value.trim();
            if (!text) return;
            
            // å¦‚æœæ­£åœ¨ç”Ÿæˆæˆ–æ’­æ”¾è¯­éŸ³ï¼Œé˜»æ­¢å‘é€
            if (isVoiceGenerating || isVoicePlaying) {
                console.log('â¸ï¸ è¯­éŸ³æ­£åœ¨ç”Ÿæˆ/æ’­æ”¾ä¸­ï¼Œè¯·ç¨å€™...');
                setStatus('èŠ±å°è»Ÿæ­£åœ¨è¯´è¯ï¼Œè¯·ç¨å€™...');
                setTimeout(() => setStatus(''), 2000);
                return;
            }

            addMessage('user', text);
            textInput.value = '';
            
            // æ·»åŠ æ€è€ƒå‹•ç•«æ¶ˆæ¯ï¼ˆåœ¨æ¶ˆæ¯æ°£æ³¡å€åŸŸï¼‰
            const thinkingMessage = addThinkingMessage();
            
            // ç¦ç”¨è¾“å…¥ï¼Œå¼€å§‹ç”Ÿæˆ
            setInputEnabled(false);
            isVoiceGenerating = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text,
                        history: conversationHistory, // Step â‘¢-B: å‚³éå°è©±æ­·å²
                        userIdentity: currentUserIdentity, // æ­¸å±¬è¨˜æ†¶ï¼šå‚³éèº«ä»½
                        userName: currentUserName, // å‚³éç”¨æˆ¶åç¨±
                    }),
                });
                
                // æª¢æ¸¬æ˜¯å¦æåˆ°ã€Œè€çˆ¸ã€é—œéµè©ï¼Œæ›´æ–°èƒŒæ™¯
                if (text.includes('è€çˆ¸') || text.includes('é™ˆå¨å»·') || text.includes('é™³å¨å»·')) {
                    document.body.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%)';
                    currentUserIdentity = 'dad';
                    console.log('ğŸ’– æª¢æ¸¬åˆ°è€çˆ¸ï¼Œåˆ‡æ›ç‚ºè¦ªæš±æ¨¡å¼');
                }

                const data = await response.json();
                
                // ç§»é™¤æ€è€ƒæ¶ˆæ¯ï¼Œæ·»åŠ å¯¦éš›å›å¾©ï¼ˆåŒ…å« toneTagï¼‰
                removeThinkingMessage();
                const messageElement = addMessage('assistant', data.reply, false, null, data.toneTag || null);
                
                // æ›´æ–°å°è©±æ­·å²
                if (data.history) {
                    conversationHistory = data.history;
                    saveConversationHistory(); // ä¿å­˜å°è©±æ­·å²
                }
                
                // ç”Ÿæˆä¸¦æ’­æ”¾èªéŸ³ï¼ˆå¸¶æƒ…ç·’æ§åˆ¶ï¼‰ï¼Œä¸¦æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
                if (data.reply && data.reply.trim()) {
                    try {
                        await playTextAsSpeech(data.reply, data.emotion, messageElement);
                    } catch (audioError) {
                        console.error('âŒ èªéŸ³æ’­æ”¾éŒ¯èª¤:', audioError);
                        // å³ä½¿èªéŸ³æ’­æ”¾å¤±æ•—ï¼Œä¹Ÿä¸å½±éŸ¿å°è©±æµç¨‹
                        isVoiceGenerating = false;
                        if (!isVoicePlaying) {
                            setInputEnabled(true);
                        }
                    }
                } else {
                    // æ²’æœ‰å›å¾©æ–‡å­—ï¼Œç›´æ¥å•Ÿç”¨è¼¸å…¥
                    isVoiceGenerating = false;
                    setInputEnabled(true);
                }
            } catch (error) {
                // å¦‚æœå‡ºé”™ï¼Œä¹Ÿè¦ç§»é™¤æ€è€ƒæ¶ˆæ¯
                removeThinkingMessage();
                addMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›å•é¡Œ ğŸ˜…');
                console.error('Error:', error);
            } finally {
                // ç¡®ä¿ç§»é™¤æ€è€ƒæ¶ˆæ¯ï¼ˆé˜²æ­¢å¼‚å¸¸æƒ…å†µï¼‰
                removeThinkingMessage();
                // è¯­éŸ³ç”Ÿæˆå®Œæˆï¼Œä½†æ’­æ”¾å¯èƒ½è¿˜åœ¨è¿›è¡Œï¼ŒplayTextAsSpeech ä¼šå¤„ç†
                isVoiceGenerating = false;
                // å¦‚æœä¸åœ¨æ’­æ”¾ï¼Œé‡æ–°å¯ç”¨è¾“å…¥
                if (!isVoicePlaying) {
                    setInputEnabled(true);
                }
            }
        }

        // ç™¼é€èªéŸ³è¨Šæ¯
        async function sendVoiceMessage(audioBlob, fileExtension = 'webm') {
            // å¦‚æœæ­£åœ¨ç”Ÿæˆæˆ–æ’­æ”¾è¯­éŸ³ï¼Œé˜»æ­¢å‘é€
            if (isVoiceGenerating || isVoicePlaying) {
                console.log('â¸ï¸ è¯­éŸ³æ­£åœ¨ç”Ÿæˆ/æ’­æ”¾ä¸­ï¼Œè¯·ç¨å€™...');
                setStatus('èŠ±å°è»Ÿæ­£åœ¨è¯´è¯ï¼Œè¯·ç¨å€™...');
                setTimeout(() => setStatus(''), 2000);
                return;
            }
            
            setStatus('æ­£åœ¨è™•ç†èªéŸ³...');
            console.log(`ğŸ“¤ ç™¼é€èªéŸ³è¨Šæ¯ï¼Œå¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
            
            // ç¦ç”¨è¾“å…¥
            setInputEnabled(false);
            isVoiceGenerating = true;

            try {
                const formData = new FormData();
                // ä½¿ç”¨æ­£ç¢ºçš„æ–‡ä»¶æ“´å±•å
                formData.append('audio', audioBlob, `recording.${fileExtension}`);
                formData.append('language', 'zh');
                formData.append('history', JSON.stringify(conversationHistory));
                if (currentUserIdentity) {
                    formData.append('userIdentity', currentUserIdentity);
                }
                if (currentUserName) {
                    formData.append('userName', currentUserName);
                }

                console.log('ğŸ“¡ ç™¼é€è«‹æ±‚åˆ° /api/voice-chat...');
                
                // æ·»åŠ æ€è€ƒå‹•ç•«ï¼ˆåœ¨ç™¼é€è«‹æ±‚å¾Œï¼Œç­‰å¾…éŸ¿æ‡‰æœŸé–“ï¼‰
                addThinkingMessage();
                
                const response = await fetch('/api/voice-chat', {
                    method: 'POST',
                    body: formData,
                });

                console.log(`ğŸ“¥ æ”¶åˆ°å›æ‡‰ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ æœå‹™å™¨éŒ¯èª¤:', errorText);
                    throw new Error(`æœå‹™å™¨éŒ¯èª¤: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('ğŸ“¦ å›æ‡‰æ•¸æ“š:', data);
                
                if (data.success) {
                    // é¡¯ç¤ºç”¨æˆ¶èªªçš„è©±ï¼ˆè¯­éŸ³è½¬æ–‡å­—çš„ç»“æœæ˜¾ç¤ºåœ¨å³ä¾§æ°”æ³¡ï¼‰
                    if (data.transcribedText && data.transcribedText.trim()) {
                        addMessage('user', data.transcribedText, true);
                        console.log('ğŸ“ ç”¨æˆ·è¯­éŸ³è½¬æ–‡å­—:', data.transcribedText);
                    } else {
                        console.warn('âš ï¸ æœªæ”¶åˆ°è½¬å½•æ–‡å­—');
                    }
                    
                    // ç§»é™¤æ€è€ƒå‹•ç•«ï¼Œé¡¯ç¤ºèŠ±å°è»Ÿå›æ‡‰ï¼ˆåŒ…å« toneTagï¼‰
                    removeThinkingMessage();
                    const messageElement = addMessage('assistant', data.text, true, data.audio, data.toneTag || null);
                    
                    // æ›´æ–°å°è©±æ­·å²ï¼ˆStep â‘¢-B: ä¿æŒè¨˜æ†¶ï¼‰
                    conversationHistory = data.history || [];
                    saveConversationHistory(); // ä¿å­˜å°è©±æ­·å²
                    
                    // å¦‚æœæœ‰éŸ³é »ï¼Œè‡ªå‹•æ’­æ”¾ï¼ˆèªéŸ³è¼¸å…¥å·²åŒ…å«éŸ³é »ï¼‰
                    if (data.audio) {
                        // ç­‰å¾…ä¸€ä¸‹ç¢ºä¿ DOM æ›´æ–°
                        setTimeout(async () => {
                            const audioElement = messageElement.querySelector('audio');
                            if (audioElement) {
                                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢å½“å‰æ’­æ”¾
                                if (currentAudio && !currentAudio.paused && currentAudio !== audioElement) {
                                    currentAudio.pause();
                                    currentAudio.currentTime = 0;
                                    console.log('â¹ï¸ åœæ­¢å½“å‰æ’­æ”¾çš„è¯­éŸ³');
                                }
                                
                                currentAudio = audioElement;
                                isVoicePlaying = true;
                                
                                // æ’­æ”¾å®Œæˆå¾Œé‡æ–°å•Ÿç”¨è¼¸å…¥
                                audioElement.addEventListener('ended', () => {
                                    console.log('âœ… èªéŸ³æ’­æ”¾å®Œæˆ');
                                    isVoicePlaying = false;
                                    isVoiceGenerating = false;
                                    currentAudio = null;
                                    setInputEnabled(true);
                                    setStatus('');
                                }, { once: true });
                                
                                // æ’­æ”¾éŒ¯èª¤è™•ç†
                                audioElement.addEventListener('error', () => {
                                    console.error('âŒ éŸ³é »æ’­æ”¾éŒ¯èª¤');
                                    isVoicePlaying = false;
                                    isVoiceGenerating = false;
                                    currentAudio = null;
                                    setInputEnabled(true);
                                    setStatus('');
                                }, { once: true });
                                
                                // é–‹å§‹æ’­æ”¾ï¼ˆè™•ç†è‡ªå‹•æ’­æ”¾é™åˆ¶ï¼‰
                                try {
                                    const playPromise = audioElement.play();
                                    if (playPromise !== undefined) {
                                        await playPromise;
                                        console.log('ğŸ”Š é–‹å§‹æ’­æ”¾èªéŸ³ï¼ˆè‡ªå‹•æ’­æ”¾æˆåŠŸï¼‰');
                                    }
                                } catch (playError) {
                                    console.warn('âš ï¸ è‡ªå‹•æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ¶é»æ“Š:', playError);
                                    // é¡¯ç¤ºæ’­æ”¾å™¨ï¼Œè®“ç”¨æˆ¶æ‰‹å‹•æ’­æ”¾
                                    audioElement.style.display = 'block';
                                    setStatus('è«‹é»æ“Šæ’­æ”¾æŒ‰éˆ•æ”¶è½èªéŸ³');
                                    isVoicePlaying = false; // é‡ç½®ç‹€æ…‹ï¼Œç­‰å¾…ç”¨æˆ¶é»æ“Š
                                    isVoiceGenerating = false;
                                    currentAudio = null;
                                    setInputEnabled(true);
                                    setTimeout(() => setStatus(''), 5000);
                                }
                            } else {
                                // æ²’æœ‰éŸ³é »å…ƒç´ ï¼Œç›´æ¥å•Ÿç”¨è¼¸å…¥
                                isVoiceGenerating = false;
                                setInputEnabled(true);
                            }
                        }, 100);
                    } else {
                        // æ²’æœ‰éŸ³é »ï¼Œç›´æ¥å•Ÿç”¨è¼¸å…¥
                        isVoiceGenerating = false;
                        setInputEnabled(true);
                    }
                    
                    // å¯é¸ï¼šé¡¯ç¤ºæª¢æ¸¬åˆ°çš„æƒ…ç·’
                    if (data.emotion && data.emotion !== 'å¹³éœ') {
                        console.log(`æª¢æ¸¬åˆ°æƒ…ç·’: ${data.emotion}`);
                    }
                    
                    // æª¢æ¸¬å›æ‡‰ä¸­æ˜¯å¦æåˆ°ã€Œæƒ³å›å®¶æ‰¾è€çˆ¸ã€ï¼Œè¡¨ç¤ºæ˜¯é™Œç”Ÿäººæ¨¡å¼
                    if (data.text && (data.text.includes('æƒ³å›å®¶') || data.text.includes('è€çˆ¸ä¸åœ¨') || data.text.includes('å›å®¶æ‰¾è€çˆ¸'))) {
                        document.body.style.background = 'linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%)';
                        if (!currentUserIdentity || currentUserIdentity !== 'dad') {
                            currentUserIdentity = 'other';
                            console.log('ğŸŒ æª¢æ¸¬åˆ°é™Œç”Ÿäººæ¨¡å¼ï¼ŒèŠ±å°è»Ÿæƒ³å›å®¶æ‰¾è€çˆ¸');
                        }
                    }
                } else {
                    // å¦‚æœå¤±è´¥ï¼Œç§»é™¤æ€è€ƒæ¶ˆæ¯
                    removeThinkingMessage();
                    console.error('âŒ èªéŸ³è™•ç†å¤±æ•—:', data.error || 'æœªçŸ¥éŒ¯èª¤');
                    addMessage('assistant', `æŠ±æ­‰ï¼Œæˆ‘æ²’è½æ¸…æ¥šï¼Œå¯ä»¥å†èªªä¸€æ¬¡å—ï¼ŸğŸ˜… (éŒ¯èª¤: ${data.error || 'æœªçŸ¥'})`);
                }
            } catch (error) {
                // å¦‚æœå‡ºé”™ï¼Œç§»é™¤æ€è€ƒæ¶ˆæ¯
                removeThinkingMessage();
                console.error('âŒ èªéŸ³è™•ç†éŒ¯èª¤:', error);
                addMessage('assistant', `èªéŸ³è™•ç†é‡åˆ°å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ ğŸ˜… (${error.message})`);
            } finally {
                // ç¡®ä¿ç§»é™¤æ€è€ƒæ¶ˆæ¯ï¼ˆé˜²æ­¢å¼‚å¸¸æƒ…å†µï¼‰
                removeThinkingMessage();
                // å¦‚æœä¸åœ¨æ’­æ”¾ï¼Œé‡æ–°å¯ç”¨è¾“å…¥
                if (!isVoicePlaying) {
                    isVoiceGenerating = false;
                    setInputEnabled(true);
                }
                setTimeout(() => setStatus(''), 3000);
            }
        }

        // æ·»åŠ è¨Šæ¯åˆ°èŠå¤©
        function addMessage(role, text, isVoice = false, audioBase64 = null, toneTag = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            
            const avatar = role === 'user' ? 'ğŸ‘¤' : ''; // åŠ©æ‰‹é ­åƒä½¿ç”¨åœ–ç‰‡ï¼Œä¸éœ€è¦ emoji
            
            let audioHtml = '';
            if (isVoice && audioBase64) {
                audioHtml = `
                    <div class="message-audio">
                        <audio class="audio-player" controls>
                            <source src="data:audio/wav;base64,${audioBase64}" type="audio/wav">
                        </audio>
                    </div>
                `;
            }
            
            // èªæ°£æ¨™ç±¤ï¼ˆåªåœ¨åŠ©æ‰‹æ¶ˆæ¯ä¸”å­˜åœ¨ toneTag æ™‚é¡¯ç¤ºï¼‰
            let toneTagHtml = '';
            if (role === 'assistant' && toneTag && toneTag.emoji && toneTag.label) {
                toneTagHtml = `
                    <div class="tone-tag">
                        <span class="tone-emoji">${toneTag.emoji}</span>
                        <span class="tone-label">${toneTag.label}</span>
                    </div>
                `;
            }
            
            // å‰µå»ºé ­åƒå…ƒç´ 
            const avatarEl = document.createElement('div');
            avatarEl.className = 'message-avatar';
            
            if (role === 'assistant') {
                // åŠ©æ‰‹é ­åƒï¼šå˜—è©¦è¼‰å…¥åœ–ç‰‡
                const img = new Image();
                img.onload = () => {
                    avatarEl.style.backgroundImage = `url('/images/huangrong-avatar.jpg')`;
                };
                img.onerror = () => {
                    // åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºå‚™ç”¨ emoji
                    avatarEl.setAttribute('data-image-error', 'true');
                    avatarEl.innerHTML = 'ğŸŒ¸';
                };
                img.src = '/images/huangrong-avatar.jpg';
            } else {
                avatarEl.textContent = avatar;
            }
            
            messageEl.innerHTML = `
                <div class="message-content">
                    ${text}
                    ${audioHtml}
                    ${toneTagHtml}
                </div>
            `;
            messageEl.insertBefore(avatarEl, messageEl.firstChild);
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // ä¿å­˜åˆ°æ¶ˆæ¯æ­·å²ï¼ˆç”¨æ–¼æ¢å¾©å°è©±è¨˜éŒ„ï¼‰
            messageHistory.push({
                role: role,
                text: text,
                audioBase64: audioBase64 || null,
                toneTag: toneTag || null,
                timestamp: Date.now()
            });
            
            // ä¿å­˜åˆ° localStorageï¼ˆé™åˆ¶æ•¸é‡ï¼Œé¿å…å­˜å„²éå¤§ï¼‰
            if (messageHistory.length > 100) {
                // åªä¿ç•™æœ€è¿‘100æ¢æ¶ˆæ¯
                messageHistory = messageHistory.slice(-100);
            }
            saveConversationHistory();
            
            // è¿”å›æ¶ˆæ¯å…ƒç´ ï¼Œæ–¹ä¾¿å¾ŒçºŒæ·»åŠ éŸ³é »æ’­æ”¾å™¨
            return messageEl;
        }
        
        // æ·»åŠ æ€è€ƒå‹•ç•«æ¶ˆæ¯ï¼ˆè‡¨æ™‚æ¶ˆæ¯ï¼Œç¨å¾Œæœƒè¢«æ›¿æ›ï¼‰
        function addThinkingMessage() {
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant thinking-message';
            messageEl.setAttribute('data-thinking', 'true'); // æ¨™è¨˜ç‚ºæ€è€ƒæ¶ˆæ¯
            
            messageEl.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="thinking-animation">
                        <div class="thinking-ball"></div>
                        <div class="thinking-ball"></div>
                        <div class="thinking-ball"></div>
                    </div>
                </div>
            `;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // è¿”å›æ¶ˆæ¯å…ƒç´ ï¼Œæ–¹ä¾¿å¾ŒçºŒæ›¿æ›
            return messageEl;
        }
        
        // ç§»é™¤æ€è€ƒæ¶ˆæ¯
        function removeThinkingMessage() {
            const thinkingMessage = messagesEl.querySelector('[data-thinking="true"]');
            if (thinkingMessage) {
                thinkingMessage.remove();
            }
        }

        // æ’­æ”¾æ–‡å­—ç‚ºèªéŸ³ï¼ˆæ”¯æŒæƒ…ç·’æ§åˆ¶ï¼‰ï¼Œä¸¦æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
        async function playTextAsSpeech(textToSpeak, emotion = null, messageElement = null) {
            const text = textToSpeak; // ä¿å­˜åŸå§‹æ–‡æœ¬ä¾›é‡è©¦ä½¿ç”¨
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢å½“å‰æ’­æ”¾
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                console.log('â¹ï¸ åœæ­¢å½“å‰æ’­æ”¾çš„è¯­éŸ³');
            }
            
            try {
                // æ ‡è®°ä¸ºæ­£åœ¨ç”Ÿæˆ
                isVoiceGenerating = true;
                
                const response = await fetch('/api/speak-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text,
                        emotion, // Step â‘¢-B: å‚³éæƒ…ç·’è®“èªéŸ³è¡¨é”ç›¸æ‡‰èªæ°£
                    }),
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    
                    // æª¢æŸ¥éŸ³é » blob æ˜¯å¦æœ‰æ•ˆ
                    if (!audioBlob || audioBlob.size === 0) {
                        throw new Error('éŸ³é »æ•¸æ“šç‚ºç©º');
                    }
                    
                    console.log(`âœ… æ”¶åˆ°éŸ³é »æ•¸æ“šï¼Œå¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
                    
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // å¾éŸ¿æ‡‰ Header ç²å– toneTag
                    const toneTagEmoji = response.headers.get('X-Tone-Tag-Emoji');
                    const toneTagLabel = response.headers.get('X-Tone-Tag-Label');
                    const toneTag = (toneTagEmoji && toneTagLabel) ? {
                        emoji: toneTagEmoji,
                        label: toneTagLabel
                    } : null;
                    
                    // å°‡éŸ³é »è½‰æ›ç‚º base64 ä»¥ä¾¿ä¿å­˜ï¼ˆç”¨æ–¼å°è©±è¨˜éŒ„æ¢å¾©ï¼‰
                    const audioBase64 = await blobToBase64(audioBlob);
                    
                    // å¦‚æœæä¾›äº†æ¶ˆæ¯å…ƒç´ ï¼Œæ·»åŠ éŸ³é »æ’­æ”¾å™¨ï¼ˆä½¿ç”¨ base64 ä»¥ä¾¿æŒä¹…ä¿å­˜ï¼‰
                    if (messageElement) {
                        console.log('ğŸµ æ·»åŠ éŸ³é »æ’­æ”¾å™¨åˆ°æ¶ˆæ¯å…ƒç´ ');
                        addAudioPlayerToMessage(messageElement, audioUrl, audioBase64);
                        
                        // å¦‚æœæœ‰ toneTagï¼Œæ·»åŠ åˆ°æ¶ˆæ¯å…ƒç´ ä¸­
                        if (toneTag) {
                            const messageContent = messageElement.querySelector('.message-content');
                            if (messageContent && !messageContent.querySelector('.tone-tag')) {
                                const toneTagHtml = `
                                    <div class="tone-tag">
                                        <span class="tone-emoji">${toneTag.emoji}</span>
                                        <span class="tone-label">${toneTag.label}</span>
                                    </div>
                                `;
                                messageContent.insertAdjacentHTML('beforeend', toneTagHtml);
                            }
                        }
                        
                        // æ›´æ–°æ¶ˆæ¯æ­·å²ä¸­çš„éŸ³é » base64 å’Œ toneTagï¼ˆç”¨æ–¼å°è©±è¨˜éŒ„æ¢å¾©ï¼‰
                        if (messageHistory.length > 0) {
                            // æ‰¾åˆ°å°æ‡‰çš„æ¶ˆæ¯ä¸¦æ›´æ–°
                            const lastMessage = messageHistory[messageHistory.length - 1];
                            if (lastMessage && lastMessage.role === 'assistant' && lastMessage.text === text.trim()) {
                                lastMessage.audioBase64 = audioBase64;
                                if (toneTag) {
                                    lastMessage.toneTag = toneTag;
                                }
                                saveConversationHistory(); // ä¿å­˜æ›´æ–°
                            }
                        }
                    }
                    
                    // å‰µå»ºæ–°çš„éŸ³é »å°è±¡ä¸¦æ’­æ”¾
                    const audio = new Audio(audioUrl);
                    currentAudio = audio;
                    
                    // æ¨™è¨˜ç‚ºæ­£åœ¨æ’­æ”¾
                    isVoicePlaying = true;
                    
                    // æ’­æ”¾å®Œæˆå¾Œé‡æ–°å•Ÿç”¨è¼¸å…¥
                    audio.addEventListener('ended', () => {
                        console.log('âœ… èªéŸ³æ’­æ”¾å®Œæˆ');
                        isVoicePlaying = false;
                        isVoiceGenerating = false;
                        currentAudio = null;
                        setInputEnabled(true);
                        setStatus('');
                    });
                    
                    // æ’­æ”¾éŒ¯èª¤è™•ç†
                    audio.addEventListener('error', (e) => {
                        console.error('âŒ éŸ³é »æ’­æ”¾éŒ¯èª¤:', e);
                        isVoicePlaying = false;
                        isVoiceGenerating = false;
                        currentAudio = null;
                        setInputEnabled(true);
                        setStatus('');
                    });
                    
                    // ç¢ºä¿æ’­æ”¾å™¨é¡¯ç¤ºï¼ˆç„¡è«–è‡ªå‹•æ’­æ”¾æ˜¯å¦æˆåŠŸï¼‰
                    if (messageElement) {
                        const audioPlayer = messageElement.querySelector('.audio-player');
                        if (audioPlayer) {
                            audioPlayer.style.display = 'block';
                            // æ·»åŠ é»æ“Šæ’­æ”¾çš„äº‹ä»¶ç›£è½å™¨
                            audioPlayer.addEventListener('play', () => {
                                console.log('âœ… ç”¨æˆ¶æ’­æ”¾èªéŸ³');
                                isVoicePlaying = true;
                                isVoiceGenerating = true;
                                setInputEnabled(false);
                            }, { once: true });
                            
                            audioPlayer.addEventListener('pause', () => {
                                console.log('â¸ï¸ ç”¨æˆ¶æš«åœèªéŸ³');
                                if (audioPlayer.paused) {
                                    isVoicePlaying = false;
                                }
                            });
                        }
                    }
                    
                    // é–‹å§‹æ’­æ”¾ï¼ˆæ·»åŠ éŒ¯èª¤è™•ç†ä»¥æ‡‰å°è‡ªå‹•æ’­æ”¾é™åˆ¶ï¼‰
                    try {
                        // å˜—è©¦è‡ªå‹•æ’­æ”¾
                        const playPromise = audio.play();
                        if (playPromise !== undefined) {
                            await playPromise;
                            console.log('ğŸ”Š é–‹å§‹æ’­æ”¾èªéŸ³ï¼ˆè‡ªå‹•æ’­æ”¾æˆåŠŸï¼‰');
                        }
                    } catch (playError) {
                        console.warn('âš ï¸ è‡ªå‹•æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ¶äº¤äº’:', playError);
                        // å¦‚æœè‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œé¡¯ç¤ºæç¤ºï¼Œä½†æ’­æ”¾å™¨å·²ç¶“é¡¯ç¤ºäº†
                        setStatus('è«‹é»æ“Šæ’­æ”¾æŒ‰éˆ•æ”¶è½èªéŸ³ï¼ˆè‡ªå‹•æ’­æ”¾è¢«ç€è¦½å™¨é˜»æ­¢ï¼‰');
                        // é‡ç½®ç‹€æ…‹ï¼ˆä½†ä¿æŒéŸ³é »å°è±¡å’Œæ’­æ”¾å™¨é¡¯ç¤ºï¼‰
                        isVoicePlaying = false;
                        isVoiceGenerating = false;
                        // ä¿ç•™ currentAudio å¼•ç”¨ï¼Œè®“ç”¨æˆ¶å¯ä»¥é»æ“Šæ’­æ”¾
                        setInputEnabled(true);
                        // 5ç§’å¾Œæ¸…é™¤æç¤º
                        setTimeout(() => setStatus(''), 5000);
                    }
                } else {
                    console.error('âŒ TTS éŸ¿æ‡‰å¤±æ•—:', response.status, response.statusText);
                    let errorText = '';
                    let errorJson = null;
                    try {
                        errorText = await response.text();
                        console.error('éŒ¯èª¤è©³æƒ…:', errorText);
                        // å˜—è©¦è§£æ JSON éŒ¯èª¤ä¿¡æ¯
                        try {
                            errorJson = JSON.parse(errorText);
                        } catch (e) {
                            // ä¸æ˜¯ JSONï¼Œå¿½ç•¥
                        }
                    } catch (e) {
                        console.error('ç„¡æ³•è®€å–éŒ¯èª¤è©³æƒ…');
                    }
                    
                    // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤ä¿¡æ¯çµ¦ç”¨æˆ¶ï¼ˆä¸å½±éŸ¿å°è©±ï¼‰
                    if (messageElement) {
                        const errorHint = errorJson?.hint || errorJson?.error || 'èªéŸ³æœå‹™æš«æ™‚ä¸å¯ç”¨';
                        const errorCode = errorJson?.error || response.status;
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'tts-error-message';
                        errorDiv.style.cssText = 'color: #ff5fa2; font-size: 0.8rem; margin-top: 8px; padding: 8px 12px; background: rgba(255, 95, 162, 0.08); border-radius: 8px; border-left: 3px solid #ff5fa2; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;';
                        
                        const icon = document.createElement('span');
                        icon.textContent = 'ğŸ”‡';
                        icon.style.fontSize = '1rem';
                        
                        const text = document.createElement('span');
                        text.style.flex = '1';
                        text.textContent = `èªéŸ³æš«æ™‚ç„¡æ³•æ’­æ”¾ï¼ˆ${errorHint}ï¼‰ï¼Œä½†æ–‡å­—æ¶ˆæ¯å·²æ”¶åˆ° âœ“`;
                        
                        // æ·»åŠ è©³ç´°éŒ¯èª¤ä¿¡æ¯ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰
                        if (errorJson?.error && errorJson.error.includes('environment variable')) {
                            text.textContent = `èªéŸ³æš«æ™‚ç„¡æ³•æ’­æ”¾ï¼ˆè«‹æª¢æŸ¥ Railway ç’°å¢ƒè®Šæ•¸è¨­ç½®ï¼‰ï¼Œä½†æ–‡å­—æ¶ˆæ¯å·²æ”¶åˆ° âœ“`;
                        } else if (errorJson?.error && errorJson.error.includes('voice') || errorJson?.error.includes('Voice')) {
                            text.textContent = `èªéŸ³æš«æ™‚ç„¡æ³•æ’­æ”¾ï¼ˆVoiceID å¯èƒ½ç„¡æ•ˆï¼‰ï¼Œä½†æ–‡å­—æ¶ˆæ¯å·²æ”¶åˆ° âœ“`;
                        }
                        
                    const retryBtn = document.createElement('button');
                    retryBtn.textContent = 'é‡è©¦';
                    retryBtn.style.cssText = 'margin-left: auto; padding: 4px 12px; background: #ff5fa2; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;';
                    retryBtn.onclick = () => {
                        errorDiv.remove();
                        // å¾æ¶ˆæ¯å…ƒç´ ä¸­ç²å–æ–‡æœ¬å…§å®¹
                        const messageText = messageElement ? messageElement.querySelector('.message-content')?.firstChild?.textContent?.trim() : null;
                        if (messageText) {
                            playTextAsSpeech(messageText, null, messageElement).catch(err => {
                                console.error('é‡è©¦å¤±æ•—:', err);
                            });
                        }
                    };
                        
                        errorDiv.appendChild(icon);
                        errorDiv.appendChild(text);
                        errorDiv.appendChild(retryBtn);
                        
                        const messageContent = messageElement.querySelector('.message-content');
                        if (messageContent) {
                            // ç§»é™¤èˆŠçš„éŒ¯èª¤ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                            const oldError = messageContent.querySelector('.tts-error-message');
                            if (oldError) oldError.remove();
                            messageContent.appendChild(errorDiv);
                        }
                    }
                    
                    setStatus('èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œä½†æ–‡å­—æ¶ˆæ¯å·²æ”¶åˆ°');
                    setTimeout(() => setStatus(''), 3000);
                }
            } catch (error) {
                console.error('âŒ TTS Error:', error);
                console.error('éŒ¯èª¤å †ç–Š:', error.stack);
                
                // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤ä¿¡æ¯çµ¦ç”¨æˆ¶ï¼ˆä¸å½±éŸ¿å°è©±ï¼‰
                if (messageElement) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'tts-error-message';
                    errorDiv.style.cssText = 'color: #ff5fa2; font-size: 0.8rem; margin-top: 8px; padding: 8px 12px; background: rgba(255, 95, 162, 0.08); border-radius: 8px; border-left: 3px solid #ff5fa2; display: flex; align-items: center; gap: 8px;';
                    
                    const icon = document.createElement('span');
                    icon.textContent = 'ğŸ”‡';
                    icon.style.fontSize = '1rem';
                    
                    const text = document.createElement('span');
                    text.textContent = `èªéŸ³æš«æ™‚ç„¡æ³•æ’­æ”¾ï¼Œä½†æ–‡å­—æ¶ˆæ¯å·²æ”¶åˆ° âœ“`;
                    
                    const retryBtn = document.createElement('button');
                    retryBtn.textContent = 'é‡è©¦';
                    retryBtn.style.cssText = 'margin-left: auto; padding: 4px 12px; background: #ff5fa2; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;';
                    retryBtn.onclick = () => {
                        errorDiv.remove();
                        // å¾æ¶ˆæ¯å…ƒç´ ä¸­ç²å–æ–‡æœ¬å…§å®¹
                        const messageText = messageElement ? messageElement.querySelector('.message-content')?.firstChild?.textContent?.trim() : null;
                        if (messageText) {
                            playTextAsSpeech(messageText, null, messageElement).catch(err => {
                                console.error('é‡è©¦å¤±æ•—:', err);
                            });
                        }
                    };
                    
                    errorDiv.appendChild(icon);
                    errorDiv.appendChild(text);
                    errorDiv.appendChild(retryBtn);
                    
                    const messageContent = messageElement.querySelector('.message-content');
                    if (messageContent) {
                        // ç§»é™¤èˆŠçš„éŒ¯èª¤ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                        const oldError = messageContent.querySelector('.tts-error-message');
                        if (oldError) oldError.remove();
                        messageContent.appendChild(errorDiv);
                    }
                }
                
                setStatus('èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œä½†æ–‡å­—æ¶ˆæ¯å·²æ”¶åˆ°');
                setTimeout(() => setStatus(''), 3000);
                isVoiceGenerating = false;
                isVoicePlaying = false;
                currentAudio = null;
                setInputEnabled(true);
            }
        }
        
        // æ·»åŠ éŸ³é »æ’­æ”¾å™¨åˆ°æ¶ˆæ¯ä¸­
        function addAudioPlayerToMessage(messageElement, audioUrl, audioBase64 = null) {
            if (!messageElement) {
                console.error('âŒ addAudioPlayerToMessage: messageElement ç‚ºç©º');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰éŸ³é »æ’­æ”¾å™¨
            const existingAudio = messageElement.querySelector('.message-audio');
            if (existingAudio) {
                // æ›´æ–°ç¾æœ‰æ’­æ”¾å™¨çš„æº
                const audio = existingAudio.querySelector('audio');
                if (audio) {
                    // å¦‚æœæä¾›äº† base64ï¼Œä½¿ç”¨ base64ï¼ˆæ›´æŒä¹…ï¼‰ï¼Œå¦å‰‡ä½¿ç”¨ URL
                    if (audioBase64) {
                        audio.src = `data:audio/wav;base64,${audioBase64}`;
                        console.log('âœ… æ›´æ–°ç¾æœ‰æ’­æ”¾å™¨ï¼ˆä½¿ç”¨ base64ï¼‰');
                    } else {
                        audio.src = audioUrl;
                        console.log('âœ… æ›´æ–°ç¾æœ‰æ’­æ”¾å™¨ï¼ˆä½¿ç”¨ URLï¼‰');
                    }
                    audio.load(); // é‡æ–°è¼‰å…¥éŸ³é »
                    audio.style.display = 'block'; // ç¢ºä¿é¡¯ç¤º
                    existingAudio.style.display = 'block'; // ç¢ºä¿å®¹å™¨ä¹Ÿé¡¯ç¤º
                }
                return;
            }
            
            // å‰µå»ºæ–°çš„éŸ³é »æ’­æ”¾å™¨
            const messageContent = messageElement.querySelector('.message-content');
            if (!messageContent) {
                console.error('âŒ addAudioPlayerToMessage: æ‰¾ä¸åˆ° .message-content');
                return;
            }
            
            // å¦‚æœæä¾›äº† base64ï¼Œä½¿ç”¨ base64ï¼ˆæ›´æŒä¹…ï¼‰ï¼Œå¦å‰‡ä½¿ç”¨ URL
            const audioSrc = audioBase64 
                ? `data:audio/wav;base64,${audioBase64}` 
                : audioUrl;
            
            console.log(`ğŸµ å‰µå»ºæ–°éŸ³é »æ’­æ”¾å™¨ï¼Œæº: ${audioBase64 ? 'base64' : 'URL'}`);
            
            const audioHtml = `
                <div class="message-audio" style="display: block !important; margin-top: 8px;">
                    <audio class="audio-player" controls preload="auto" style="display: block !important; width: 100%;">
                        <source src="${audioSrc}" type="audio/wav">
                    </audio>
                </div>
            `;
            messageContent.insertAdjacentHTML('beforeend', audioHtml);
            
            // ç¢ºä¿æ’­æ”¾å™¨ç«‹å³é¡¯ç¤º
            const audioPlayer = messageContent.querySelector('.audio-player');
            const audioContainer = messageContent.querySelector('.message-audio');
            
            if (audioPlayer && audioContainer) {
                audioPlayer.style.display = 'block';
                audioContainer.style.display = 'block';
                console.log('âœ… éŸ³é »æ’­æ”¾å™¨å·²æ·»åŠ åˆ°æ¶ˆæ¯ä¸­ä¸¦ç¢ºä¿é¡¯ç¤º');
                
                // é©—è­‰æ’­æ”¾å™¨æ˜¯å¦çœŸçš„å¯è¦‹
                setTimeout(() => {
                    const computedStyle = window.getComputedStyle(audioPlayer);
                    console.log(`ğŸ” æ’­æ”¾å™¨é¡¯ç¤ºç‹€æ…‹: display=${computedStyle.display}, visibility=${computedStyle.visibility}, opacity=${computedStyle.opacity}`);
                    if (computedStyle.display === 'none') {
                        console.warn('âš ï¸ æ’­æ”¾å™¨è¢«éš±è—äº†ï¼å¼·åˆ¶é¡¯ç¤º...');
                        audioPlayer.style.display = 'block !important';
                        audioContainer.style.display = 'block !important';
                    }
                }, 100);
            } else {
                console.error('âŒ ç„¡æ³•æ‰¾åˆ°å‰µå»ºçš„éŸ³é »æ’­æ”¾å™¨å…ƒç´ ');
            }
        }

        // é–‹å§‹éŒ„éŸ³ï¼ˆå¸¶å¯¦æ™‚å¯è¦–åŒ–å’ŒèªéŸ³è­˜åˆ¥ï¼‰
        async function startRecording() {
            try {
                console.log('ğŸ¤ é–‹å§‹éŒ„éŸ³...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // åˆå§‹åŒ– Web Audio APIï¼ˆç”¨æ–¼å¯è¦–åŒ–ï¼‰
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // é¡¯ç¤ºå¯è¦–åŒ–
                visualizerEl.classList.add('active');
                drawWaveform();
                
                // å•Ÿå‹•å¯¦æ™‚èªéŸ³è­˜åˆ¥
                if (recognition) {
                    try {
                        recognition.start();
                        console.log('ğŸ™ï¸ å¯¦æ™‚èªéŸ³è­˜åˆ¥å·²å•Ÿå‹•');
                    } catch (e) {
                        console.log('èªéŸ³è­˜åˆ¥å¯èƒ½å·²ç¶“å•Ÿå‹•');
                    }
                }
                
                // æª¢æ¸¬æ”¯æŒçš„ MIME é¡å‹
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                    mimeType = 'audio/webm';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                }
                
                console.log(`ğŸ“ ä½¿ç”¨éŸ³é »æ ¼å¼: ${mimeType}`);
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });
                
                audioChunks = [];
                realtimeTranscript = ''; // é‡ç½®è½‰éŒ„æ–‡å­—
                silenceStartTime = null; // é‡ç½®é™éŸ³è®¡æ—¶
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        console.log(`ğŸ“¦ éŒ„éŸ³æ•¸æ“šå¡Š: ${event.data.size} bytes`);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const recordingDuration = recordingStartTime ? Date.now() - recordingStartTime : 0;
                    console.log(`âœ… éŒ„éŸ³å®Œæˆï¼Œå…± ${audioChunks.length} å€‹æ•¸æ“šå¡Šï¼Œæ™‚é•·: ${(recordingDuration / 1000).toFixed(2)} ç§’`);
                    
                    // åœæ­¢å¯è¦–åŒ–ï¼ˆå»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æœ€ç»ˆè½¬å½•ç»“æœï¼‰
                    setTimeout(() => {
                        visualizerEl.classList.remove('active');
                        transcriptEl.classList.remove('active');
                        if (transcriptTextEl) transcriptTextEl.textContent = '';
                    }, 500);
                    
                    // åœæ­¢èªéŸ³è­˜åˆ¥
                    if (recognition) {
                        recognition.stop();
                    }
                    
                    // åœæ­¢éŸ³é »åˆ†æ
                    if (microphone) {
                        microphone.disconnect();
                    }
                    if (audioContext && audioContext.state !== 'closed') {
                        audioContext.close();
                    }
                    
                    // æª¢æŸ¥éŒ„éŸ³æ™‚é•·
                    if (recordingDuration < MIN_RECORDING_DURATION) {
                        console.warn(`âš ï¸ éŒ„éŸ³æ™‚é•·å¤ªçŸ­: ${(recordingDuration / 1000).toFixed(2)} ç§’ï¼Œæœ€å°è¦æ±‚: ${(MIN_RECORDING_DURATION / 1000).toFixed(1)} ç§’`);
                        setStatus(`éŒ„éŸ³å¤ªçŸ­ï¼Œè«‹è‡³å°‘éŒ„è£½ ${(MIN_RECORDING_DURATION / 1000).toFixed(1)} ç§’ï¼ˆç›®å‰ ${(recordingDuration / 1000).toFixed(1)} ç§’ï¼‰`);
                        stream.getTracks().forEach(track => track.stop());
                        isRecording = false;
                        voiceBtn.classList.remove('recording');
                        recordingStartTime = null;
                        silenceStartTime = null; // é‡ç½®é™éŸ³è®¡æ—¶
                        
                        // æ¸…ç†å¯è¦–åŒ–å’Œè½‰éŒ„
                        if (visualizerEl) visualizerEl.classList.remove('active');
                        if (transcriptEl) transcriptEl.classList.remove('active');
                        return;
                    }
                    
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    console.log(`ğŸ“Š éŸ³é » Blob å¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
                    
                    // æª¢æŸ¥éŸ³é »æ–‡ä»¶å¤§å°ï¼ˆè‡³å°‘ 2KBï¼Œç¢ºä¿æœ‰å¯¦éš›å…§å®¹ï¼‰
                    if (audioBlob.size < 2048) {
                        console.warn(`âš ï¸ éŸ³é »æ–‡ä»¶å¤ªå°: ${audioBlob.size} bytesï¼Œå¯èƒ½æ˜¯ç©ºéŒ„éŸ³æˆ–æ ¼å¼å•é¡Œ`);
                        setStatus(`éŒ„éŸ³å…§å®¹å¤ªçŸ­æˆ–ç„¡æ•ˆï¼ˆ${(audioBlob.size / 1024).toFixed(2)} KBï¼‰ï¼Œè«‹é‡æ–°éŒ„è£½è‡³å°‘ 0.5 ç§’`);
                        stream.getTracks().forEach(track => track.stop());
                        isRecording = false;
                        voiceBtn.classList.remove('recording');
                        recordingStartTime = null;
                        silenceStartTime = null; // é‡ç½®é™éŸ³è®¡æ—¶
                        
                        // æ¸…ç†å¯è¦–åŒ–å’Œè½‰éŒ„
                        if (visualizerEl) visualizerEl.classList.remove('active');
                        if (transcriptEl) transcriptEl.classList.remove('active');
                        return;
                    }
                    
                    // é©—è­‰éŸ³é »æ ¼å¼æ˜¯å¦æœ‰æ•ˆ
                    if (!audioBlob.type || audioBlob.type === 'application/octet-stream') {
                        console.warn(`âš ï¸ éŸ³é »æ ¼å¼æœªè­˜åˆ¥: ${audioBlob.type}`);
                        // æ ¹æ“š mimeType è¨­ç½®æ­£ç¢ºçš„ type
                        audioBlob.type = mimeType;
                    }
                    
                    // ç¢ºå®šæ–‡ä»¶æ“´å±•åï¼ˆå„ªå…ˆä½¿ç”¨ Whisper æ”¯æŒçš„æ ¼å¼ï¼‰
                    // Whisper API æ”¯æŒï¼šflac, m4a, mp3, mp4, mpeg, mpga, oga, ogg, wav, webm
                    let fileExtension = 'webm';
                    if (mimeType.includes('mp4')) {
                        fileExtension = 'mp4';
                    } else if (mimeType.includes('webm')) {
                        fileExtension = 'webm';
                    } else if (mimeType.includes('ogg')) {
                        fileExtension = 'ogg';
                    }
                    // æ³¨æ„ï¼šå¦‚æœç€è¦½å™¨ä¸æ”¯æŒ webmï¼Œå¯èƒ½éœ€è¦è½‰æ›ç‚º wav
                    // ä½†ç›®å‰å…ˆä½¿ç”¨ç€è¦½å™¨åŸç”Ÿæ ¼å¼
                    
                    console.log(`ğŸ“¦ éŸ³é »æ ¼å¼: ${mimeType}, æ“´å±•å: ${fileExtension}`);
                    
                    // å¦‚æœæœ‰å¯¦æ™‚è½‰éŒ„çš„æ–‡å­—ï¼Œä½¿ç”¨å®ƒï¼›å¦å‰‡ç™¼é€éŸ³é »
                    if (realtimeTranscript.trim()) {
                        console.log(`ğŸ“ ä½¿ç”¨å¯¦æ™‚è½‰éŒ„: "${realtimeTranscript}"`);
                        // ç›´æ¥ä½¿ç”¨è½‰éŒ„çš„æ–‡å­—ç™¼é€
                        await sendTextAsVoice(realtimeTranscript);
                    } else {
                        await sendVoiceMessage(audioBlob, fileExtension);
                    }
                    
                    stream.getTracks().forEach(track => track.stop());
                    recordingStartTime = null;
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('âŒ MediaRecorder éŒ¯èª¤:', event.error);
                    setStatus('éŒ„éŸ³ç™¼ç”ŸéŒ¯èª¤');
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now(); // è¨˜éŒ„é–‹å§‹æ™‚é–“
                voiceBtn.classList.add('recording');
                // ä¸åœ¨è¿™é‡Œè®¾ç½®çŠ¶æ€ï¼Œè®©å¯è§†åŒ–ç»„ä»¶è‡ªå·±æ˜¾ç¤º"æ­£åœ¨éŒ„éŸ³..."
                // setStatus('æ­£åœ¨éŒ„éŸ³...');
                console.log('ğŸ™ï¸ éŒ„éŸ³ä¸­...');
            } catch (error) {
                console.error('âŒ éŒ„éŸ³éŒ¯èª¤:', error);
                if (error.name === 'NotAllowedError') {
                    setStatus('ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼šè«‹å…è¨±ç€è¦½å™¨è¨ªå•éº¥å…‹é¢¨æ¬Šé™');
                } else if (error.name === 'NotFoundError') {
                    setStatus('æ‰¾ä¸åˆ°éº¥å…‹é¢¨è¨­å‚™');
                } else {
                    setStatus('ç„¡æ³•è¨ªå•éº¥å…‹é¢¨ï¼š' + error.message);
                }
                
                // æ¸…ç†è³‡æº
                if (visualizerEl) visualizerEl.classList.remove('active');
                if (transcriptEl) transcriptEl.classList.remove('active');
                if (recognition) recognition.stop();
                recordingStartTime = null;
                silenceStartTime = null; // é‡ç½®é™éŸ³è®¡æ—¶
            }
        }
        
        // ä½¿ç”¨å¯¦æ™‚è½‰éŒ„çš„æ–‡å­—ç™¼é€ï¼ˆä½œç‚ºèªéŸ³è¼¸å…¥ï¼‰
        async function sendTextAsVoice(text) {
            setStatus('æ­£åœ¨è™•ç†...');
            
            // å…ˆé¡¯ç¤ºç”¨æˆ¶èªªçš„è©±ï¼ˆèªéŸ³è½‰æ–‡å­—çµæœé¡¯ç¤ºåœ¨å³å´æ°£æ³¡ï¼‰
            if (text && text.trim()) {
                addMessage('user', text.trim(), true);
                console.log('ğŸ“ ç”¨æˆ¶èªéŸ³è½‰æ–‡å­—ï¼ˆå¯¦æ™‚è½‰éŒ„ï¼‰:', text.trim());
            }
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        history: conversationHistory,
                        userIdentity: currentUserIdentity,
                        userName: currentUserName,
                    }),
                });
                
                    const data = await response.json();
                    const messageElement = addMessage('assistant', data.reply);
                    
                    if (data.history) {
                        conversationHistory = data.history;
                    }
                    
                    if (data.reply) {
                        await playTextAsSpeech(data.reply, data.emotion, messageElement);
                    }
            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›å•é¡Œ ğŸ˜…');
                isVoiceGenerating = false;
                if (!isVoicePlaying) {
                    setInputEnabled(true);
                }
            } finally {
                if (!isVoicePlaying) {
                    setStatus('');
                }
            }
        }

        // åœæ­¢éŒ„éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                // æª¢æŸ¥éŒ„éŸ³æ™‚é•·ï¼ˆåœ¨åœæ­¢å‰æª¢æŸ¥ï¼‰
                const recordingDuration = recordingStartTime ? Date.now() - recordingStartTime : 0;
                
                if (recordingDuration < MIN_RECORDING_DURATION) {
                    console.warn(`âš ï¸ éŒ„éŸ³æ™‚é•·å¤ªçŸ­: ${(recordingDuration / 1000).toFixed(2)} ç§’ï¼Œå»ºè­°ç¹¼çºŒéŒ„éŸ³...`);
                    setStatus(`ğŸ’¡ å»ºè­°è‡³å°‘éŒ„è£½ ${(MIN_RECORDING_DURATION / 1000).toFixed(1)} ç§’ï¼ˆç›®å‰ ${(recordingDuration / 1000).toFixed(1)} ç§’ï¼‰`);
                    
                    // å¦‚æœçœŸçš„å¾ˆçŸ­ï¼ˆ< 0.3ç§’ï¼‰ï¼Œå¼·åˆ¶ç¹¼çºŒéŒ„éŸ³
                    if (recordingDuration < 300) {
                        console.log('â¸ï¸ éŒ„éŸ³å¤ªçŸ­ï¼Œç¹¼çºŒéŒ„éŸ³...');
                        return;
                    }
                    // å¦‚æœæ¥è¿‘æœ€å°å€¼ï¼Œå…è¨±åœæ­¢ä½†æœƒé¡¯ç¤ºè­¦å‘Š
                }
                
                console.log('â¹ï¸  åœæ­¢éŒ„éŸ³...');
                
                // ç«‹å³éšè—å¯è§†åŒ–ï¼Œé¿å…é‡å 
                if (visualizerEl) visualizerEl.classList.remove('active');
                
                // é‡ç½®é™éŸ³è®¡æ—¶
                silenceStartTime = null;
                
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                setStatus('æ­£åœ¨è™•ç†èªéŸ³...');
                
                // åœæ­¢å¯è¦–åŒ–å‹•ç•«
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                
                // åœæ­¢èªéŸ³è­˜åˆ¥
                if (recognition) {
                    recognition.stop();
                }
            }
        }

        // å·¥å…·å‡½æ•¸
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function setStatus(text) {
            // æ³¨æ„ï¼šæ€è€ƒåŠ¨ç”»ç°åœ¨æ˜¾ç¤ºåœ¨æ¶ˆæ¯æ°”æ³¡ä¸­ï¼Œä¸åœ¨çŠ¶æ€æ 
            // çŠ¶æ€æ åªæ˜¾ç¤ºå…¶ä»–çŠ¶æ€ä¿¡æ¯
            if (!text || text.trim() === '') {
                statusEl.innerHTML = '';
                statusEl.classList.remove('thinking');
                return;
            }
            // ä¸å†åœ¨çŠ¶æ€æ æ˜¾ç¤ºæ€è€ƒåŠ¨ç”»ï¼ˆå·²ç§»è‡³æ¶ˆæ¯æ°”æ³¡ï¼‰
            if (text.includes('æ­£åœ¨æ€è€ƒ') || text.includes('æ€è€ƒä¸­')) {
                // æ€è€ƒçŠ¶æ€ç”±æ¶ˆæ¯æ°”æ³¡å¤„ç†ï¼Œè¿™é‡Œä¸æ˜¾ç¤º
                return;
            }
            // å…¶ä»–çŠ¶æ€æ˜¾ç¤ºæ–‡å­—
            statusEl.textContent = text;
            statusEl.classList.remove('thinking');
        }

        // äº‹ä»¶ç›£è½
        sendBtn.addEventListener('click', sendTextMessage);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendTextMessage();
        });

        // èªéŸ³æŒ‰éˆ•äº‹ä»¶ï¼ˆæŒ‰ä½èªªè©±ï¼‰
        voiceBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startRecording();
        });
        voiceBtn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            stopRecording();
        });
        voiceBtn.addEventListener('mouseleave', (e) => {
            if (isRecording) {
                stopRecording();
            }
        });
        
        // è§¸æ‘¸äº‹ä»¶ï¼ˆç§»å‹•è¨­å‚™ï¼‰
        voiceBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startRecording();
        });
        voiceBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRecording();
        });
        voiceBtn.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            if (isRecording) {
                stopRecording();
            }
        });
        
        // é»æ“Šäº‹ä»¶ï¼ˆå‚™ç”¨ï¼šé»æ“Šé–‹å§‹ï¼Œå†æ¬¡é»æ“Šåœæ­¢ï¼‰
        let clickTimer = null;
        voiceBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!isRecording) {
                startRecording();
                // è‡ªå‹•åœ¨ 30 ç§’å¾Œåœæ­¢ï¼ˆé˜²æ­¢å¿˜è¨˜ï¼‰
                clickTimer = setTimeout(() => {
                    if (isRecording) {
                        console.log('â° è‡ªå‹•åœæ­¢éŒ„éŸ³ï¼ˆ30ç§’è¶…æ™‚ï¼‰');
                        stopRecording();
                    }
                }, 30000);
            } else {
                if (clickTimer) clearTimeout(clickTimer);
                stopRecording();
            }
        });
        
        // åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
        initSpeechRecognition();
        
        // é é¢åŠ è¼‰æ™‚æ¢å¾©å°è©±è¨˜éŒ„
        document.addEventListener('DOMContentLoaded', () => {
            restoreConversationHistory();
        });
        
        // å¦‚æœ DOM å·²ç¶“åŠ è¼‰å®Œæˆï¼Œç«‹å³æ¢å¾©
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', restoreConversationHistory);
        } else {
            // DOM å·²ç¶“åŠ è¼‰å®Œæˆï¼Œç«‹å³æ¢å¾©
            restoreConversationHistory();
        }
    </script>
</body>
</html>

